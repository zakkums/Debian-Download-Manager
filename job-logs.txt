2026-02-21T03:50:32.8531297Z Current runner version: '2.331.0'
2026-02-21T03:50:32.8564255Z ##[group]Runner Image Provisioner
2026-02-21T03:50:32.8565511Z Hosted Compute Agent
2026-02-21T03:50:32.8566365Z Version: 20260123.484
2026-02-21T03:50:32.8567439Z Commit: 6bd6555ca37d84114959e1c76d2c01448ff61c5d
2026-02-21T03:50:32.8568558Z Build Date: 2026-01-23T19:41:17Z
2026-02-21T03:50:32.8569847Z Worker ID: {b7fa22e2-9d87-4347-b799-0873d5f4090f}
2026-02-21T03:50:32.8570940Z Azure Region: northcentralus
2026-02-21T03:50:32.8571875Z ##[endgroup]
2026-02-21T03:50:32.8574425Z ##[group]Operating System
2026-02-21T03:50:32.8575355Z Ubuntu
2026-02-21T03:50:32.8576093Z 24.04.3
2026-02-21T03:50:32.8576914Z LTS
2026-02-21T03:50:32.8577623Z ##[endgroup]
2026-02-21T03:50:32.8578383Z ##[group]Runner Image
2026-02-21T03:50:32.8579348Z Image: ubuntu-24.04
2026-02-21T03:50:32.8580181Z Version: 20260201.15.1
2026-02-21T03:50:32.8582465Z Included Software: https://github.com/actions/runner-images/blob/ubuntu24/20260201.15/images/ubuntu/Ubuntu2404-Readme.md
2026-02-21T03:50:32.8585401Z Image Release: https://github.com/actions/runner-images/releases/tag/ubuntu24%2F20260201.15
2026-02-21T03:50:32.8587183Z ##[endgroup]
2026-02-21T03:50:32.8589181Z ##[group]GITHUB_TOKEN Permissions
2026-02-21T03:50:32.8592008Z Contents: read
2026-02-21T03:50:32.8593291Z Metadata: read
2026-02-21T03:50:32.8594244Z Packages: read
2026-02-21T03:50:32.8595059Z ##[endgroup]
2026-02-21T03:50:32.8597978Z Secret source: Actions
2026-02-21T03:50:32.8599044Z Prepare workflow directory
2026-02-21T03:50:32.9147777Z Prepare all required actions
2026-02-21T03:50:32.9203544Z Getting action download info
2026-02-21T03:50:33.2147653Z Download action repository 'actions/checkout@v4' (SHA:34e114876b0b11c390a56381ad16ebd13914f8d5)
2026-02-21T03:50:33.2919462Z Download action repository 'dtolnay/rust-toolchain@stable' (SHA:631a55b12751854ce901bb631d5902ceb48146f7)
2026-02-21T03:50:33.5144139Z Download action repository 'actions/cache@v4' (SHA:0057852bfaa89a56745cba8c7296529d2fc39830)
2026-02-21T03:50:33.7379215Z Complete job name: Check (rustfmt + clippy)
2026-02-21T03:50:33.8035468Z ##[group]Run actions/checkout@v4
2026-02-21T03:50:33.8036272Z with:
2026-02-21T03:50:33.8036689Z   repository: zakkums/Debian-Download-Manager
2026-02-21T03:50:33.8037370Z   token: ***
2026-02-21T03:50:33.8037743Z   ssh-strict: true
2026-02-21T03:50:33.8038133Z   ssh-user: git
2026-02-21T03:50:33.8038522Z   persist-credentials: true
2026-02-21T03:50:33.8038957Z   clean: true
2026-02-21T03:50:33.8039342Z   sparse-checkout-cone-mode: true
2026-02-21T03:50:33.8039801Z   fetch-depth: 1
2026-02-21T03:50:33.8040167Z   fetch-tags: false
2026-02-21T03:50:33.8040553Z   show-progress: true
2026-02-21T03:50:33.8040947Z   lfs: false
2026-02-21T03:50:33.8041303Z   submodules: false
2026-02-21T03:50:33.8041703Z   set-safe-directory: true
2026-02-21T03:50:33.8042311Z env:
2026-02-21T03:50:33.8042667Z   RUST_BACKTRACE: 1
2026-02-21T03:50:33.8043045Z ##[endgroup]
2026-02-21T03:50:33.9106203Z Syncing repository: zakkums/Debian-Download-Manager
2026-02-21T03:50:33.9108019Z ##[group]Getting Git version info
2026-02-21T03:50:33.9108892Z Working directory is '/home/runner/work/Debian-Download-Manager/Debian-Download-Manager'
2026-02-21T03:50:33.9110002Z [command]/usr/bin/git version
2026-02-21T03:50:33.9180593Z git version 2.52.0
2026-02-21T03:50:33.9206574Z ##[endgroup]
2026-02-21T03:50:33.9219197Z Temporarily overriding HOME='/home/runner/work/_temp/ef439d75-4c1b-4499-b2ef-d5c4d9f93708' before making global git config changes
2026-02-21T03:50:33.9220537Z Adding repository directory to the temporary git global config as a safe directory
2026-02-21T03:50:33.9230586Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/Debian-Download-Manager/Debian-Download-Manager
2026-02-21T03:50:33.9267503Z Deleting the contents of '/home/runner/work/Debian-Download-Manager/Debian-Download-Manager'
2026-02-21T03:50:33.9270761Z ##[group]Initializing the repository
2026-02-21T03:50:33.9275043Z [command]/usr/bin/git init /home/runner/work/Debian-Download-Manager/Debian-Download-Manager
2026-02-21T03:50:33.9360911Z hint: Using 'master' as the name for the initial branch. This default branch name
2026-02-21T03:50:33.9362127Z hint: will change to "main" in Git 3.0. To configure the initial branch name
2026-02-21T03:50:33.9363049Z hint: to use in all of your new repositories, which will suppress this warning,
2026-02-21T03:50:33.9364071Z hint: call:
2026-02-21T03:50:33.9364429Z hint:
2026-02-21T03:50:33.9365006Z hint: 	git config --global init.defaultBranch <name>
2026-02-21T03:50:33.9365858Z hint:
2026-02-21T03:50:33.9366402Z hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
2026-02-21T03:50:33.9367281Z hint: 'development'. The just-created branch can be renamed via this command:
2026-02-21T03:50:33.9367976Z hint:
2026-02-21T03:50:33.9368330Z hint: 	git branch -m <name>
2026-02-21T03:50:33.9368764Z hint:
2026-02-21T03:50:33.9369338Z hint: Disable this message with "git config set advice.defaultBranchName false"
2026-02-21T03:50:33.9370913Z Initialized empty Git repository in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/.git/
2026-02-21T03:50:33.9375743Z [command]/usr/bin/git remote add origin https://github.com/zakkums/Debian-Download-Manager
2026-02-21T03:50:33.9406883Z ##[endgroup]
2026-02-21T03:50:33.9407996Z ##[group]Disabling automatic garbage collection
2026-02-21T03:50:33.9411275Z [command]/usr/bin/git config --local gc.auto 0
2026-02-21T03:50:33.9440697Z ##[endgroup]
2026-02-21T03:50:33.9441344Z ##[group]Setting up auth
2026-02-21T03:50:33.9447405Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2026-02-21T03:50:33.9476413Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2026-02-21T03:50:33.9780488Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2026-02-21T03:50:33.9809017Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2026-02-21T03:50:34.0021673Z [command]/usr/bin/git config --local --name-only --get-regexp ^includeIf\.gitdir:
2026-02-21T03:50:34.0052766Z [command]/usr/bin/git submodule foreach --recursive git config --local --show-origin --name-only --get-regexp remote.origin.url
2026-02-21T03:50:34.0290840Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2026-02-21T03:50:34.0323862Z ##[endgroup]
2026-02-21T03:50:34.0325097Z ##[group]Fetching the repository
2026-02-21T03:50:34.0333592Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +3bb86b32173ca8a8db1ee9fb10dab3b87329d657:refs/remotes/origin/main
2026-02-21T03:50:34.2955633Z From https://github.com/zakkums/Debian-Download-Manager
2026-02-21T03:50:34.2957322Z  * [new ref]         3bb86b32173ca8a8db1ee9fb10dab3b87329d657 -> origin/main
2026-02-21T03:50:34.2988217Z ##[endgroup]
2026-02-21T03:50:34.2989456Z ##[group]Determining the checkout info
2026-02-21T03:50:34.2992268Z ##[endgroup]
2026-02-21T03:50:34.2996770Z [command]/usr/bin/git sparse-checkout disable
2026-02-21T03:50:34.3037744Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2026-02-21T03:50:34.3065198Z ##[group]Checking out the ref
2026-02-21T03:50:34.3069260Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2026-02-21T03:50:34.3174051Z Switched to a new branch 'main'
2026-02-21T03:50:34.3175477Z branch 'main' set up to track 'origin/main'.
2026-02-21T03:50:34.3179951Z ##[endgroup]
2026-02-21T03:50:34.3214097Z [command]/usr/bin/git log -1 --format=%H
2026-02-21T03:50:34.3235675Z 3bb86b32173ca8a8db1ee9fb10dab3b87329d657
2026-02-21T03:50:34.3795860Z ##[group]Run dtolnay/rust-toolchain@stable
2026-02-21T03:50:34.3796984Z with:
2026-02-21T03:50:34.3797950Z   components: rustfmt, clippy
2026-02-21T03:50:34.3798876Z   toolchain: stable
2026-02-21T03:50:34.3799634Z env:
2026-02-21T03:50:34.3800317Z   RUST_BACKTRACE: 1
2026-02-21T03:50:34.3801084Z ##[endgroup]
2026-02-21T03:50:34.3935026Z ##[group]Run : parse toolchain version
2026-02-21T03:50:34.3936139Z [36;1m: parse toolchain version[0m
2026-02-21T03:50:34.3937154Z [36;1mif [[ -z $toolchain ]]; then[0m
2026-02-21T03:50:34.3938945Z [36;1m  # GitHub does not enforce `required: true` inputs itself. https://github.com/actions/runner/issues/1070[0m
2026-02-21T03:50:34.3940880Z [36;1m  echo "'toolchain' is a required input" >&2[0m
2026-02-21T03:50:34.3941954Z [36;1m  exit 1[0m
2026-02-21T03:50:34.3943238Z [36;1melif [[ $toolchain =~ ^stable' '[0-9]+' '(year|month|week|day)s?' 'ago$ ]]; then[0m
2026-02-21T03:50:34.3944690Z [36;1m  if [[ Linux == macOS ]]; then[0m
2026-02-21T03:50:34.3946592Z [36;1m    echo "toolchain=1.$((($(date -v-$(sed 's/stable \([0-9]*\) \(.\).*/\1\2/' <<< $toolchain) +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.3948445Z [36;1m  else[0m
2026-02-21T03:50:34.3949843Z [36;1m    echo "toolchain=1.$((($(date --date "${toolchain#stable }" +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.3951452Z [36;1m  fi[0m
2026-02-21T03:50:34.3952458Z [36;1melif [[ $toolchain =~ ^stable' 'minus' '[0-9]+' 'releases?$ ]]; then[0m
2026-02-21T03:50:34.3954413Z [36;1m  echo "toolchain=1.$((($(date +%s)/60/60/24-16569)/7/6-${toolchain//[^0-9]/}))" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.3956036Z [36;1melif [[ $toolchain =~ ^1\.[0-9]+$ ]]; then[0m
2026-02-21T03:50:34.3957906Z [36;1m  echo "toolchain=1.$((i=${toolchain#1.}, c=($(date +%s)/60/60/24-16569)/7/6, i+9*i*(10*i<=c)+90*i*(100*i<=c)))" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.3959671Z [36;1melse[0m
2026-02-21T03:50:34.3960529Z [36;1m  echo "toolchain=$toolchain" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.3961598Z [36;1mfi[0m
2026-02-21T03:50:34.3997819Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:34.3999007Z env:
2026-02-21T03:50:34.3999633Z   RUST_BACKTRACE: 1
2026-02-21T03:50:34.4000345Z   toolchain: stable
2026-02-21T03:50:34.4001039Z ##[endgroup]
2026-02-21T03:50:34.4161031Z ##[group]Run : construct rustup command line
2026-02-21T03:50:34.4162113Z [36;1m: construct rustup command line[0m
2026-02-21T03:50:34.4228158Z [36;1mecho "targets=$(for t in ${targets//,/ }; do echo -n ' --target' $t; done)" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.4230738Z [36;1mecho "components=$(for c in ${components//,/ }; do echo -n ' --component' $c; done)" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.4232520Z [36;1mecho "downgrade=" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:34.4262793Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:34.4264139Z env:
2026-02-21T03:50:34.4264761Z   RUST_BACKTRACE: 1
2026-02-21T03:50:34.4265497Z   targets: 
2026-02-21T03:50:34.4266169Z   components: rustfmt, clippy
2026-02-21T03:50:34.4266990Z ##[endgroup]
2026-02-21T03:50:34.4376466Z ##[group]Run : set $CARGO_HOME
2026-02-21T03:50:34.4377318Z [36;1m: set $CARGO_HOME[0m
2026-02-21T03:50:34.4378420Z [36;1mecho CARGO_HOME=${CARGO_HOME:-"$HOME/.cargo"} >> $GITHUB_ENV[0m
2026-02-21T03:50:34.4408124Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:34.4409235Z env:
2026-02-21T03:50:34.4409833Z   RUST_BACKTRACE: 1
2026-02-21T03:50:34.4410522Z ##[endgroup]
2026-02-21T03:50:34.4514691Z ##[group]Run : install rustup if needed
2026-02-21T03:50:34.4515643Z [36;1m: install rustup if needed[0m
2026-02-21T03:50:34.4516623Z [36;1mif ! command -v rustup &>/dev/null; then[0m
2026-02-21T03:50:34.4519133Z [36;1m  curl --proto '=https' --tlsv1.2 --retry 10 --retry-connrefused --location --silent --show-error --fail https://sh.rustup.rs | sh -s -- --default-toolchain none -y[0m
2026-02-21T03:50:34.4521829Z [36;1m  echo "$CARGO_HOME/bin" >> $GITHUB_PATH[0m
2026-02-21T03:50:34.4522809Z [36;1mfi[0m
2026-02-21T03:50:34.4551831Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:34.4553069Z env:
2026-02-21T03:50:34.4554250Z   RUST_BACKTRACE: 1
2026-02-21T03:50:34.4555095Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:34.4555986Z ##[endgroup]
2026-02-21T03:50:34.4662583Z ##[group]Run rustup toolchain install stable --component rustfmt --component clippy --profile minimal --no-self-update
2026-02-21T03:50:34.4665495Z [36;1mrustup toolchain install stable --component rustfmt --component clippy --profile minimal --no-self-update[0m
2026-02-21T03:50:34.4695781Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:34.4696872Z env:
2026-02-21T03:50:34.4697462Z   RUST_BACKTRACE: 1
2026-02-21T03:50:34.4698175Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:34.4699027Z   RUSTUP_PERMIT_COPY_RENAME: 1
2026-02-21T03:50:34.4699808Z ##[endgroup]
2026-02-21T03:50:34.6554372Z info: syncing channel updates for 'stable-x86_64-unknown-linux-gnu'
2026-02-21T03:50:34.7097767Z info: latest update on 2026-02-12, rust version 1.93.1 (01f6ddf75 2026-02-11)
2026-02-21T03:50:34.7346845Z info: downloading component 'clippy'
2026-02-21T03:50:34.7701747Z info: downloading component 'rustfmt'
2026-02-21T03:50:34.7970152Z info: downloading component 'cargo'
2026-02-21T03:50:34.8519080Z info: downloading component 'rust-std'
2026-02-21T03:50:34.9563490Z info: downloading component 'rustc'
2026-02-21T03:50:35.2266658Z info: removing previous version of component 'clippy'
2026-02-21T03:50:35.2282770Z info: removing previous version of component 'rustfmt'
2026-02-21T03:50:35.2294102Z info: removing previous version of component 'cargo'
2026-02-21T03:50:35.2336883Z info: removing previous version of component 'rust-std'
2026-02-21T03:50:35.2367506Z info: removing previous version of component 'rustc'
2026-02-21T03:50:35.2419442Z info: installing component 'clippy'
2026-02-21T03:50:35.6230823Z info: installing component 'rustfmt'
2026-02-21T03:50:35.8519727Z info: installing component 'cargo'
2026-02-21T03:50:36.5410944Z info: installing component 'rust-std'
2026-02-21T03:50:38.4329392Z info: installing component 'rustc'
2026-02-21T03:50:43.0000296Z 
2026-02-21T03:50:43.0089987Z   stable-x86_64-unknown-linux-gnu updated - rustc 1.93.1 (01f6ddf75 2026-02-11) (from rustc 1.93.0 (254b59607 2026-01-19))
2026-02-21T03:50:43.0090821Z 
2026-02-21T03:50:43.0156446Z ##[group]Run rustup default stable
2026-02-21T03:50:43.0156726Z [36;1mrustup default stable[0m
2026-02-21T03:50:43.0189117Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:43.0189429Z env:
2026-02-21T03:50:43.0189600Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.0189795Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.0190021Z ##[endgroup]
2026-02-21T03:50:43.0291913Z info: using existing install for 'stable-x86_64-unknown-linux-gnu'
2026-02-21T03:50:43.0583427Z info: default toolchain set to 'stable-x86_64-unknown-linux-gnu'
2026-02-21T03:50:43.0584017Z 
2026-02-21T03:50:43.0666386Z   stable-x86_64-unknown-linux-gnu unchanged - rustc 1.93.1 (01f6ddf75 2026-02-11)
2026-02-21T03:50:43.0666995Z 
2026-02-21T03:50:43.0668170Z info: note that the toolchain 'stable-x86_64-unknown-linux-gnu' is currently in use (overridden by '/home/runner/work/Debian-Download-Manager/Debian-Download-Manager/rust-toolchain.toml')
2026-02-21T03:50:43.0710709Z ##[group]Run : create cachekey
2026-02-21T03:50:43.0710974Z [36;1m: create cachekey[0m
2026-02-21T03:50:43.0711464Z [36;1mDATE=$(rustc +stable --version --verbose | sed -ne 's/^commit-date: \(20[0-9][0-9]\)-\([01][0-9]\)-\([0-3][0-9]\)$/\1\2\3/p')[0m
2026-02-21T03:50:43.0712086Z [36;1mHASH=$(rustc +stable --version --verbose | sed -ne 's/^commit-hash: //p')[0m
2026-02-21T03:50:43.0712563Z [36;1mecho "cachekey=$(echo $DATE$HASH | head -c12)" >> $GITHUB_OUTPUT[0m
2026-02-21T03:50:43.0746409Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:43.0746726Z env:
2026-02-21T03:50:43.0747168Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.0747376Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.0747619Z ##[endgroup]
2026-02-21T03:50:43.1128692Z ##[group]Run : disable incremental compilation
2026-02-21T03:50:43.1129039Z [36;1m: disable incremental compilation[0m
2026-02-21T03:50:43.1129342Z [36;1mif [ -z "${CARGO_INCREMENTAL+set}" ]; then[0m
2026-02-21T03:50:43.1129673Z [36;1m  echo CARGO_INCREMENTAL=0 >> $GITHUB_ENV[0m
2026-02-21T03:50:43.1129973Z [36;1mfi[0m
2026-02-21T03:50:43.1162439Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:43.1162762Z env:
2026-02-21T03:50:43.1162924Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.1163301Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.1163535Z ##[endgroup]
2026-02-21T03:50:43.1233688Z ##[group]Run : enable colors in Cargo output
2026-02-21T03:50:43.1233999Z [36;1m: enable colors in Cargo output[0m
2026-02-21T03:50:43.1234288Z [36;1mif [ -z "${CARGO_TERM_COLOR+set}" ]; then[0m
2026-02-21T03:50:43.1234618Z [36;1m  echo CARGO_TERM_COLOR=always >> $GITHUB_ENV[0m
2026-02-21T03:50:43.1234889Z [36;1mfi[0m
2026-02-21T03:50:43.1265552Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:43.1265871Z env:
2026-02-21T03:50:43.1266038Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.1266246Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.1266471Z   CARGO_INCREMENTAL: 0
2026-02-21T03:50:43.1266663Z ##[endgroup]
2026-02-21T03:50:43.1339086Z ##[group]Run : enable Cargo sparse registry
2026-02-21T03:50:43.1339392Z [36;1m: enable Cargo sparse registry[0m
2026-02-21T03:50:43.1339728Z [36;1m# implemented in 1.66, stabilized in 1.68, made default in 1.70[0m
2026-02-21T03:50:43.1340413Z [36;1mif [ -z "${CARGO_REGISTRIES_CRATES_IO_PROTOCOL+set}" -o -f "/home/runner/work/_temp"/.implicit_cargo_registries_crates_io_protocol ]; then[0m
2026-02-21T03:50:43.1341114Z [36;1m  if rustc +stable --version --verbose | grep -q '^release: 1\.6[89]\.'; then[0m
2026-02-21T03:50:43.1341664Z [36;1m    touch "/home/runner/work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2026-02-21T03:50:43.1342182Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse >> $GITHUB_ENV[0m
2026-02-21T03:50:43.1342662Z [36;1m  elif rustc +stable --version --verbose | grep -q '^release: 1\.6[67]\.'; then[0m
2026-02-21T03:50:43.1343420Z [36;1m    touch "/home/runner/work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2026-02-21T03:50:43.1343925Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=git >> $GITHUB_ENV[0m
2026-02-21T03:50:43.1344249Z [36;1m  fi[0m
2026-02-21T03:50:43.1344419Z [36;1mfi[0m
2026-02-21T03:50:43.1374808Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:43.1375121Z env:
2026-02-21T03:50:43.1375285Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.1375479Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.1375714Z   CARGO_INCREMENTAL: 0
2026-02-21T03:50:43.1375905Z   CARGO_TERM_COLOR: always
2026-02-21T03:50:43.1376106Z ##[endgroup]
2026-02-21T03:50:43.1727684Z ##[group]Run : work around spurious network errors in curl 8.0
2026-02-21T03:50:43.1728108Z [36;1m: work around spurious network errors in curl 8.0[0m
2026-02-21T03:50:43.1728637Z [36;1m# https://rust-lang.zulipchat.com/#narrow/stream/246057-t-cargo/topic/timeout.20investigation[0m
2026-02-21T03:50:43.1729248Z [36;1mif rustc +stable --version --verbose | grep -q '^release: 1\.7[01]\.'; then[0m
2026-02-21T03:50:43.1729677Z [36;1m  echo CARGO_HTTP_MULTIPLEXING=false >> $GITHUB_ENV[0m
2026-02-21T03:50:43.1729959Z [36;1mfi[0m
2026-02-21T03:50:43.1763623Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:43.1763937Z env:
2026-02-21T03:50:43.1764111Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.1764311Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.1764542Z   CARGO_INCREMENTAL: 0
2026-02-21T03:50:43.1764742Z   CARGO_TERM_COLOR: always
2026-02-21T03:50:43.1764933Z ##[endgroup]
2026-02-21T03:50:43.1976301Z ##[group]Run rustc +stable --version --verbose
2026-02-21T03:50:43.1976786Z [36;1mrustc +stable --version --verbose[0m
2026-02-21T03:50:43.2008430Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2026-02-21T03:50:43.2008910Z env:
2026-02-21T03:50:43.2009085Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.2009301Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.2009540Z   CARGO_INCREMENTAL: 0
2026-02-21T03:50:43.2009739Z   CARGO_TERM_COLOR: always
2026-02-21T03:50:43.2009934Z ##[endgroup]
2026-02-21T03:50:43.2188754Z rustc 1.93.1 (01f6ddf75 2026-02-11)
2026-02-21T03:50:43.2190514Z binary: rustc
2026-02-21T03:50:43.2191008Z commit-hash: 01f6ddf7588f42ae2d7eb0a2f21d44e8e96674cf
2026-02-21T03:50:43.2191546Z commit-date: 2026-02-11
2026-02-21T03:50:43.2191803Z host: x86_64-unknown-linux-gnu
2026-02-21T03:50:43.2192058Z release: 1.93.1
2026-02-21T03:50:43.2192263Z LLVM version: 21.1.8
2026-02-21T03:50:43.3016049Z ##[group]Run actions/cache@v4
2026-02-21T03:50:43.3016307Z with:
2026-02-21T03:50:43.3016520Z   path: ~/.cargo/registry
~/.cargo/git
target

2026-02-21T03:50:43.3016971Z   key: Linux-cargo-020e3e4cedd92fa62279a0cb004da29eb01a8d7d72ec46bb7e397a1476a9e0b2
2026-02-21T03:50:43.3017415Z   restore-keys: Linux-cargo-

2026-02-21T03:50:43.3017645Z   enableCrossOsArchive: false
2026-02-21T03:50:43.3017870Z   fail-on-cache-miss: false
2026-02-21T03:50:43.3018072Z   lookup-only: false
2026-02-21T03:50:43.3018263Z   save-always: false
2026-02-21T03:50:43.3018434Z env:
2026-02-21T03:50:43.3018593Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.3018779Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.3019001Z   CARGO_INCREMENTAL: 0
2026-02-21T03:50:43.3019185Z   CARGO_TERM_COLOR: always
2026-02-21T03:50:43.3019381Z ##[endgroup]
2026-02-21T03:50:43.5636707Z Cache not found for input keys: Linux-cargo-020e3e4cedd92fa62279a0cb004da29eb01a8d7d72ec46bb7e397a1476a9e0b2, Linux-cargo-
2026-02-21T03:50:43.5701442Z ##[group]Run cargo fmt --all -- --check
2026-02-21T03:50:43.5701756Z [36;1mcargo fmt --all -- --check[0m
2026-02-21T03:50:43.5734103Z shell: /usr/bin/bash -e {0}
2026-02-21T03:50:43.5734342Z env:
2026-02-21T03:50:43.5734505Z   RUST_BACKTRACE: 1
2026-02-21T03:50:43.5734709Z   CARGO_HOME: /home/runner/.cargo
2026-02-21T03:50:43.5734944Z   CARGO_INCREMENTAL: 0
2026-02-21T03:50:43.5735152Z   CARGO_TERM_COLOR: always
2026-02-21T03:50:43.5735351Z ##[endgroup]
2026-02-21T03:50:43.7152717Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/commands/remove.rs:27:
2026-02-21T03:50:43.7157989Z                  match tokio::fs::remove_file(&path).await {
2026-02-21T03:50:43.7158746Z                      Ok(()) => tracing::debug!(path = %path.display(), "deleted file"),
2026-02-21T03:50:43.7159543Z                      Err(e) if e.kind() == std::io::ErrorKind::NotFound => {}
2026-02-21T03:50:43.7160410Z -                    Err(e) => tracing::warn!(path = %path.display(), "could not delete file: {}", e),
2026-02-21T03:50:43.7160846Z +                    Err(e) => {
2026-02-21T03:50:43.7161200Z +                        tracing::warn!(path = %path.display(), "could not delete file: {}", e)
2026-02-21T03:50:43.7161551Z +                    }
2026-02-21T03:50:43.7161746Z                  }
2026-02-21T03:50:43.7161908Z              }
2026-02-21T03:50:43.7162068Z          }
2026-02-21T03:50:43.7169906Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/commands/run.rs:25:
2026-02-21T03:50:43.7170754Z          tracing::info!("recovered {} job(s) from previous run", recovered);
2026-02-21T03:50:43.7171097Z      }
2026-02-21T03:50:43.7171419Z      let global_budget = Arc::new(GlobalConnectionBudget::new(cfg.max_total_connections));
2026-02-21T03:50:43.7171931Z -    let mut host_policy = match HostPolicy::default_path().and_then(|p| {
2026-02-21T03:50:43.7172385Z -        HostPolicy::load_from_path(&p, cfg.min_segments, cfg.max_segments)
2026-02-21T03:50:43.7172730Z -    }) {
2026-02-21T03:50:43.7172957Z +    let mut host_policy = match HostPolicy::default_path()
2026-02-21T03:50:43.7173573Z +        .and_then(|p| HostPolicy::load_from_path(&p, cfg.min_segments, cfg.max_segments))
2026-02-21T03:50:43.7173933Z +    {
2026-02-21T03:50:43.7174387Z          Ok(Some(policy)) => {
2026-02-21T03:50:43.7174686Z              tracing::debug!("loaded host policy from state file");
2026-02-21T03:50:43.7174983Z              policy
2026-02-21T03:50:43.7190046Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/mod.rs:136:
2026-02-21T03:50:43.7190858Z                  let dir = download_dir.or_else(|| std::env::current_dir().ok());
2026-02-21T03:50:43.7191231Z                  run_add(&db, &url, dir.as_deref()).await?
2026-02-21T03:50:43.7191493Z              }
2026-02-21T03:50:43.7191736Z -            CliCommand::Run { force_restart, jobs, overwrite } => {
2026-02-21T03:50:43.7192069Z +            CliCommand::Run {
2026-02-21T03:50:43.7192281Z +                force_restart,
2026-02-21T03:50:43.7192484Z +                jobs,
2026-02-21T03:50:43.7192666Z +                overwrite,
2026-02-21T03:50:43.7192861Z +            } => {
2026-02-21T03:50:43.7193251Z                  let download_dir = std::env::current_dir()?;
2026-02-21T03:50:43.7193678Z                  run_scheduler(&db, &cfg, &download_dir, force_restart, jobs, overwrite).await?;
2026-02-21T03:50:43.7194042Z              }
2026-02-21T03:50:43.7194452Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/mod.rs:143:
2026-02-21T03:50:43.7194969Z              CliCommand::Status => run_status(&db).await?,
2026-02-21T03:50:43.7195312Z              CliCommand::Pause { id } => run_pause(&db, id).await?,
2026-02-21T03:50:43.7195676Z              CliCommand::Resume { id } => run_resume(&db, id).await?,
2026-02-21T03:50:43.7196269Z -            CliCommand::Remove { id, delete_files, download_dir } => {
2026-02-21T03:50:43.7196607Z +            CliCommand::Remove {
2026-02-21T03:50:43.7196819Z +                id,
2026-02-21T03:50:43.7196993Z +                delete_files,
2026-02-21T03:50:43.7197210Z +                download_dir,
2026-02-21T03:50:43.7197404Z +            } => {
2026-02-21T03:50:43.7197592Z                  let dir = if delete_files {
2026-02-21T03:50:43.7197902Z                      download_dir.or_else(|| std::env::current_dir().ok())
2026-02-21T03:50:43.7198203Z                  } else {
2026-02-21T03:50:43.7198621Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/mod.rs:151:
2026-02-21T03:50:43.7199087Z                  };
2026-02-21T03:50:43.7199335Z                  run_remove(&db, id, delete_files, dir.as_deref()).await?
2026-02-21T03:50:43.7199856Z              }
2026-02-21T03:50:43.7200245Z -            CliCommand::ImportHar { path, allow_cookies } => {
2026-02-21T03:50:43.7200773Z +            CliCommand::ImportHar {
2026-02-21T03:50:43.7201159Z +                path,
2026-02-21T03:50:43.7201435Z +                allow_cookies,
2026-02-21T03:50:43.7201635Z +            } => {
2026-02-21T03:50:43.7201890Z                  run_import_har(&db, Path::new(&path), allow_cookies).await?;
2026-02-21T03:50:43.7202400Z              }
2026-02-21T03:50:43.7202794Z              CliCommand::Bench { url } => run_bench(&url).await?,
2026-02-21T03:50:43.7203643Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:18:
2026-02-21T03:50:43.7204113Z  
2026-02-21T03:50:43.7204259Z  #[test]
2026-02-21T03:50:43.7204425Z  fn cli_parse_add_download_dir() {
2026-02-21T03:50:43.7204828Z -    match parse(&["ddm", "add", "https://example.com/x", "--download-dir", "/tmp"]) {
2026-02-21T03:50:43.7205204Z +    match parse(&[
2026-02-21T03:50:43.7205382Z +        "ddm",
2026-02-21T03:50:43.7205539Z +        "add",
2026-02-21T03:50:43.7205726Z +        "https://example.com/x",
2026-02-21T03:50:43.7205958Z +        "--download-dir",
2026-02-21T03:50:43.7206167Z +        "/tmp",
2026-02-21T03:50:43.7206333Z +    ]) {
2026-02-21T03:50:43.7206525Z          CliCommand::Add { url, download_dir } => {
2026-02-21T03:50:43.7206836Z              assert_eq!(url, "https://example.com/x");
2026-02-21T03:50:43.7207218Z              assert_eq!(download_dir.as_deref(), Some(std::path::Path::new("/tmp")));
2026-02-21T03:50:43.7207991Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:30:
2026-02-21T03:50:43.7208461Z  #[test]
2026-02-21T03:50:43.7208627Z  fn cli_parse_run() {
2026-02-21T03:50:43.7208824Z      match parse(&["ddm", "run"]) {
2026-02-21T03:50:43.7209127Z -        CliCommand::Run { force_restart, jobs, overwrite } => {
2026-02-21T03:50:43.7209438Z +        CliCommand::Run {
2026-02-21T03:50:43.7209633Z +            force_restart,
2026-02-21T03:50:43.7209826Z +            jobs,
2026-02-21T03:50:43.7209992Z +            overwrite,
2026-02-21T03:50:43.7210378Z +        } => {
2026-02-21T03:50:43.7210560Z              assert!(!force_restart);
2026-02-21T03:50:43.7210794Z              assert_eq!(jobs, 1);
2026-02-21T03:50:43.7211010Z              assert!(!overwrite);
2026-02-21T03:50:43.7211468Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:42:
2026-02-21T03:50:43.7211947Z  #[test]
2026-02-21T03:50:43.7212111Z  fn cli_parse_run_force_restart() {
2026-02-21T03:50:43.7212382Z      match parse(&["ddm", "run", "--force-restart"]) {
2026-02-21T03:50:43.7212717Z -        CliCommand::Run { force_restart, jobs, overwrite } => {
2026-02-21T03:50:43.7213019Z +        CliCommand::Run {
2026-02-21T03:50:43.7213382Z +            force_restart,
2026-02-21T03:50:43.7213579Z +            jobs,
2026-02-21T03:50:43.7213746Z +            overwrite,
2026-02-21T03:50:43.7213926Z +        } => {
2026-02-21T03:50:43.7214095Z              assert!(force_restart);
2026-02-21T03:50:43.7214324Z              assert_eq!(jobs, 1);
2026-02-21T03:50:43.7214693Z              assert!(!overwrite);
2026-02-21T03:50:43.7215163Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:62:
2026-02-21T03:50:43.7215633Z  #[test]
2026-02-21T03:50:43.7215796Z  fn cli_parse_run_jobs() {
2026-02-21T03:50:43.7216028Z      match parse(&["ddm", "run", "--jobs", "4"]) {
2026-02-21T03:50:43.7216347Z -        CliCommand::Run { force_restart, jobs, overwrite } => {
2026-02-21T03:50:43.7216640Z +        CliCommand::Run {
2026-02-21T03:50:43.7216827Z +            force_restart,
2026-02-21T03:50:43.7217049Z +            jobs,
2026-02-21T03:50:43.7217209Z +            overwrite,
2026-02-21T03:50:43.7217384Z +        } => {
2026-02-21T03:50:43.7217563Z              assert!(!force_restart);
2026-02-21T03:50:43.7217781Z              assert_eq!(jobs, 4);
2026-02-21T03:50:43.7217991Z              assert!(!overwrite);
2026-02-21T03:50:43.7218439Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:98:
2026-02-21T03:50:43.7218905Z  #[test]
2026-02-21T03:50:43.7219057Z  fn cli_parse_remove() {
2026-02-21T03:50:43.7219274Z      match parse(&["ddm", "remove", "99"]) {
2026-02-21T03:50:43.7219583Z -        CliCommand::Remove { id, delete_files, download_dir } => {
2026-02-21T03:50:43.7219897Z +        CliCommand::Remove {
2026-02-21T03:50:43.7220100Z +            id,
2026-02-21T03:50:43.7220264Z +            delete_files,
2026-02-21T03:50:43.7220456Z +            download_dir,
2026-02-21T03:50:43.7220633Z +        } => {
2026-02-21T03:50:43.7220800Z              assert_eq!(id, 99);
2026-02-21T03:50:43.7221007Z              assert!(!delete_files);
2026-02-21T03:50:43.7221248Z              assert!(download_dir.is_none());
2026-02-21T03:50:43.7221744Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:110:
2026-02-21T03:50:43.7222258Z  #[test]
2026-02-21T03:50:43.7222430Z  fn cli_parse_remove_delete_files() {
2026-02-21T03:50:43.7222724Z      match parse(&["ddm", "remove", "1", "--delete-files"]) {
2026-02-21T03:50:43.7223219Z -        CliCommand::Remove { id, delete_files, download_dir } => {
2026-02-21T03:50:43.7223571Z +        CliCommand::Remove {
2026-02-21T03:50:43.7223762Z +            id,
2026-02-21T03:50:43.7223931Z +            delete_files,
2026-02-21T03:50:43.7224250Z +            download_dir,
2026-02-21T03:50:43.7224436Z +        } => {
2026-02-21T03:50:43.7224596Z              assert_eq!(id, 1);
2026-02-21T03:50:43.7224809Z              assert!(delete_files);
2026-02-21T03:50:43.7225036Z              assert!(download_dir.is_none());
2026-02-21T03:50:43.7225520Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:121:
2026-02-21T03:50:43.7225992Z  
2026-02-21T03:50:43.7226139Z  #[test]
2026-02-21T03:50:43.7226333Z  fn cli_parse_remove_delete_files_download_dir() {
2026-02-21T03:50:43.7226721Z -    match parse(&["ddm", "remove", "2", "--delete-files", "--download-dir", "/tmp"]) {
2026-02-21T03:50:43.7227157Z -        CliCommand::Remove { id, delete_files, download_dir } => {
2026-02-21T03:50:43.7227454Z +    match parse(&[
2026-02-21T03:50:43.7227631Z +        "ddm",
2026-02-21T03:50:43.7227788Z +        "remove",
2026-02-21T03:50:43.7227953Z +        "2",
2026-02-21T03:50:43.7228119Z +        "--delete-files",
2026-02-21T03:50:43.7228316Z +        "--download-dir",
2026-02-21T03:50:43.7228503Z +        "/tmp",
2026-02-21T03:50:43.7228657Z +    ]) {
2026-02-21T03:50:43.7228822Z +        CliCommand::Remove {
2026-02-21T03:50:43.7229013Z +            id,
2026-02-21T03:50:43.7229176Z +            delete_files,
2026-02-21T03:50:43.7229356Z +            download_dir,
2026-02-21T03:50:43.7229535Z +        } => {
2026-02-21T03:50:43.7229693Z              assert_eq!(id, 2);
2026-02-21T03:50:43.7229903Z              assert!(delete_files);
2026-02-21T03:50:43.7230236Z              assert_eq!(download_dir.as_deref(), Some(std::path::Path::new("/tmp")));
2026-02-21T03:50:43.7230939Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:134:
2026-02-21T03:50:43.7231428Z  #[test]
2026-02-21T03:50:43.7231606Z  fn cli_parse_import_har_without_cookies() {
2026-02-21T03:50:43.7231919Z      match parse(&["ddm", "import-har", "/path/to/file.har"]) {
2026-02-21T03:50:43.7232269Z -        CliCommand::ImportHar { path, allow_cookies } => {
2026-02-21T03:50:43.7232567Z +        CliCommand::ImportHar {
2026-02-21T03:50:43.7232770Z +            path,
2026-02-21T03:50:43.7232942Z +            allow_cookies,
2026-02-21T03:50:43.7233292Z +        } => {
2026-02-21T03:50:43.7233486Z              assert_eq!(path, "/path/to/file.har");
2026-02-21T03:50:43.7233749Z              assert!(!allow_cookies);
2026-02-21T03:50:43.7233957Z          }
2026-02-21T03:50:43.7234360Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:145:
2026-02-21T03:50:43.7234824Z  #[test]
2026-02-21T03:50:43.7235004Z  fn cli_parse_import_har_allow_cookies() {
2026-02-21T03:50:43.7235329Z      match parse(&["ddm", "import-har", "x.har", "--allow-cookies"]) {
2026-02-21T03:50:43.7235692Z -        CliCommand::ImportHar { path, allow_cookies } => {
2026-02-21T03:50:43.7235985Z +        CliCommand::ImportHar {
2026-02-21T03:50:43.7236186Z +            path,
2026-02-21T03:50:43.7236363Z +            allow_cookies,
2026-02-21T03:50:43.7236542Z +        } => {
2026-02-21T03:50:43.7236719Z              assert_eq!(path, "x.har");
2026-02-21T03:50:43.7236950Z              assert!(allow_cookies);
2026-02-21T03:50:43.7237162Z          }
2026-02-21T03:50:43.7237554Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/cli/tests.rs:168:
2026-02-21T03:50:43.7238049Z          _ => panic!("expected Checksum"),
2026-02-21T03:50:43.7238271Z      }
2026-02-21T03:50:43.7238420Z  }
2026-02-21T03:50:43.7238561Z -
2026-02-21T03:50:43.7238704Z  
2026-02-21T03:50:43.7239090Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-cli/src/main.rs:16:
2026-02-21T03:50:43.7239560Z          std::process::exit(1);
2026-02-21T03:50:43.7239763Z      }
2026-02-21T03:50:43.7239903Z  }
2026-02-21T03:50:43.7240045Z -
2026-02-21T03:50:43.7240178Z  
2026-02-21T03:50:43.7367926Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/bench/mod.rs:79:
2026-02-21T03:50:43.7368998Z              &segments,
2026-02-21T03:50:43.7369258Z              &storage_writer,
2026-02-21T03:50:43.7369518Z              &mut bitmap,
2026-02-21T03:50:43.7369968Z -            Some(segment_count.min(cfg.max_connections_per_host).min(cfg.max_total_connections)),
2026-02-21T03:50:43.7370472Z +            Some(
2026-02-21T03:50:43.7370688Z +                segment_count
2026-02-21T03:50:43.7371013Z +                    .min(cfg.max_connections_per_host)
2026-02-21T03:50:43.7371526Z +                    .min(cfg.max_total_connections),
2026-02-21T03:50:43.7372052Z +            ),
2026-02-21T03:50:43.7372424Z              Some(&retry_policy),
2026-02-21T03:50:43.7372785Z              &mut summary,
2026-02-21T03:50:43.7373021Z              None,
2026-02-21T03:50:43.7373837Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/bench/mod.rs:129:
2026-02-21T03:50:43.7374470Z      let best_no_errors = results
2026-02-21T03:50:43.7374731Z          .iter()
2026-02-21T03:50:43.7374960Z          .filter(|r| r.error_events == 0)
2026-02-21T03:50:43.7375547Z -        .max_by(|a, b| a.throughput_mib_s.partial_cmp(&b.throughput_mib_s).unwrap_or(std::cmp::Ordering::Equal));
2026-02-21T03:50:43.7376088Z +        .max_by(|a, b| {
2026-02-21T03:50:43.7376292Z +            a.throughput_mib_s
2026-02-21T03:50:43.7376534Z +                .partial_cmp(&b.throughput_mib_s)
2026-02-21T03:50:43.7376829Z +                .unwrap_or(std::cmp::Ordering::Equal)
2026-02-21T03:50:43.7377081Z +        });
2026-02-21T03:50:43.7377270Z      let best = best_no_errors.or_else(|| {
2026-02-21T03:50:43.7377656Z -        results
2026-02-21T03:50:43.7377840Z -            .iter()
2026-02-21T03:50:43.7378242Z -            .max_by(|a, b| a.throughput_mib_s.partial_cmp(&b.throughput_mib_s).unwrap_or(std::cmp::Ordering::Equal))
2026-02-21T03:50:43.7378893Z +        results.iter().max_by(|a, b| {
2026-02-21T03:50:43.7379299Z +            a.throughput_mib_s
2026-02-21T03:50:43.7379678Z +                .partial_cmp(&b.throughput_mib_s)
2026-02-21T03:50:43.7379974Z +                .unwrap_or(std::cmp::Ordering::Equal)
2026-02-21T03:50:43.7380218Z +        })
2026-02-21T03:50:43.7380370Z      })?;
2026-02-21T03:50:43.7380533Z      Some(best.segment_count)
2026-02-21T03:50:43.7380739Z  }
2026-02-21T03:50:43.7381171Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/checksum.rs:14:
2026-02-21T03:50:43.7381754Z  /// Compute SHA-256 of a file and return the digest as lowercase hex.
2026-02-21T03:50:43.7382476Z  /// Reads in chunks to keep memory use bounded; suitable for large files.
2026-02-21T03:50:43.7383061Z  pub fn sha256_path(path: &Path) -> Result<String> {
2026-02-21T03:50:43.7383657Z -    let mut f = File::open(path)
2026-02-21T03:50:43.7383943Z -        .with_context(|| format!("open {}", path.display()))?;
2026-02-21T03:50:43.7384372Z +    let mut f = File::open(path).with_context(|| format!("open {}", path.display()))?;
2026-02-21T03:50:43.7384774Z      let mut hasher = Sha256::new();
2026-02-21T03:50:43.7385010Z      let mut buf = [0u8; BUF_SIZE];
2026-02-21T03:50:43.7385231Z      loop {
2026-02-21T03:50:43.7385641Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/checksum.rs:22:
2026-02-21T03:50:43.7386246Z -        let n = f.read(&mut buf).with_context(|| format!("read {}", path.display()))?;
2026-02-21T03:50:43.7386595Z +        let n = f
2026-02-21T03:50:43.7386777Z +            .read(&mut buf)
2026-02-21T03:50:43.7387034Z +            .with_context(|| format!("read {}", path.display()))?;
2026-02-21T03:50:43.7387337Z          if n == 0 {
2026-02-21T03:50:43.7387513Z              break;
2026-02-21T03:50:43.7387675Z          }
2026-02-21T03:50:43.7388073Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/config.rs:116:
2026-02-21T03:50:43.7388587Z          let toml = toml::to_string_pretty(&cfg).unwrap();
2026-02-21T03:50:43.7389076Z          let parsed: DdmConfig = toml::from_str(&toml).unwrap();
2026-02-21T03:50:43.7389469Z          assert_eq!(parsed.max_total_connections, cfg.max_total_connections);
2026-02-21T03:50:43.7390064Z -        assert_eq!(parsed.max_connections_per_host, cfg.max_connections_per_host);
2026-02-21T03:50:43.7390685Z +        assert_eq!(
2026-02-21T03:50:43.7391007Z +            parsed.max_connections_per_host,
2026-02-21T03:50:43.7391271Z +            cfg.max_connections_per_host
2026-02-21T03:50:43.7391496Z +        );
2026-02-21T03:50:43.7391707Z          assert_eq!(parsed.min_segments, cfg.min_segments);
2026-02-21T03:50:43.7392036Z          assert_eq!(parsed.max_segments, cfg.max_segments);
2026-02-21T03:50:43.7392297Z      }
2026-02-21T03:50:43.7392691Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/config.rs:184:
2026-02-21T03:50:43.7393291Z          assert_eq!(retry.max_delay_secs, 15);
2026-02-21T03:50:43.7393526Z      }
2026-02-21T03:50:43.7393670Z  }
2026-02-21T03:50:43.7393812Z -
2026-02-21T03:50:43.7393946Z  
2026-02-21T03:50:43.7394352Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/control.rs:37:
2026-02-21T03:50:43.7394959Z      /// Call when starting a job; the token is set to true when pause/cancel is requested.
2026-02-21T03:50:43.7395404Z      pub fn register(&self, job_id: i64) -> Arc<AtomicBool> {
2026-02-21T03:50:43.7395745Z          let token = Arc::new(AtomicBool::new(false));
2026-02-21T03:50:43.7396091Z -        self.jobs.write().unwrap().insert(job_id, Arc::clone(&token));
2026-02-21T03:50:43.7396403Z +        self.jobs
2026-02-21T03:50:43.7396703Z +            .write()
2026-02-21T03:50:43.7396893Z +            .unwrap()
2026-02-21T03:50:43.7397096Z +            .insert(job_id, Arc::clone(&token));
2026-02-21T03:50:43.7397338Z          token
2026-02-21T03:50:43.7397490Z      }
2026-02-21T03:50:43.7397635Z  
2026-02-21T03:50:43.7398024Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/control.rs:57:
2026-02-21T03:50:43.7398484Z  
2026-02-21T03:50:43.7398732Z  /// Default path for the control socket (same XDG state dir as the DB).
2026-02-21T03:50:43.7399158Z  pub fn default_control_socket_path() -> std::io::Result<PathBuf> {
2026-02-21T03:50:43.7399607Z -    let dir = xdg::BaseDirectories::with_prefix("ddm")?.get_state_home().join("ddm");
2026-02-21T03:50:43.7400023Z +    let dir = xdg::BaseDirectories::with_prefix("ddm")?
2026-02-21T03:50:43.7400303Z +        .get_state_home()
2026-02-21T03:50:43.7400491Z +        .join("ddm");
2026-02-21T03:50:43.7400686Z      Ok(dir.join("control.sock"))
2026-02-21T03:50:43.7400902Z  }
2026-02-21T03:50:43.7401036Z  
2026-02-21T03:50:43.7401606Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/mod.rs:13:
2026-02-21T03:50:43.7402478Z  pub mod multi;
2026-02-21T03:50:43.7402678Z  pub use single::download_single;
2026-02-21T03:50:43.7402889Z  
2026-02-21T03:50:43.7403040Z -use anyhow::Result;
2026-02-21T03:50:43.7403373Z  use crate::retry::{RetryPolicy, SegmentError};
2026-02-21T03:50:43.7403680Z  use crate::segmenter::{Segment, SegmentBitmap};
2026-02-21T03:50:43.7403960Z  use crate::storage::StorageWriter;
2026-02-21T03:50:43.7404444Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/mod.rs:20:
2026-02-21T03:50:43.7404947Z +use anyhow::Result;
2026-02-21T03:50:43.7405140Z  use std::collections::HashMap;
2026-02-21T03:50:43.7405366Z  use std::sync::atomic::AtomicU64;
2026-02-21T03:50:43.7405582Z  use std::sync::Arc;
2026-02-21T03:50:43.7406037Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/mod.rs:35:
2026-02-21T03:50:43.7406524Z  
2026-02-21T03:50:43.7406678Z  impl CurlOptions {
2026-02-21T03:50:43.7407136Z      /// Derive per-handle options from a global cap and concurrency.
2026-02-21T03:50:43.7408013Z -    pub fn per_handle(global_max_bytes_per_sec: Option<u64>, concurrency: usize, buffer_size: Option<usize>) -> Self {
2026-02-21T03:50:43.7408659Z +    pub fn per_handle(
2026-02-21T03:50:43.7408878Z +        global_max_bytes_per_sec: Option<u64>,
2026-02-21T03:50:43.7409130Z +        concurrency: usize,
2026-02-21T03:50:43.7409340Z +        buffer_size: Option<usize>,
2026-02-21T03:50:43.7409559Z +    ) -> Self {
2026-02-21T03:50:43.7409773Z          let concurrency_u = (concurrency.max(1)) as u64;
2026-02-21T03:50:43.7410238Z -        let max_recv_speed = global_max_bytes_per_sec.map(|bps| (bps + concurrency_u - 1) / concurrency_u);
2026-02-21T03:50:43.7410673Z +        let max_recv_speed =
2026-02-21T03:50:43.7411011Z +            global_max_bytes_per_sec.map(|bps| (bps + concurrency_u - 1) / concurrency_u);
2026-02-21T03:50:43.7411380Z          Self {
2026-02-21T03:50:43.7411546Z              max_recv_speed,
2026-02-21T03:50:43.7411751Z              buffer_size,
2026-02-21T03:50:43.7412277Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/handler.rs:59:
2026-02-21T03:50:43.7412832Z          if self.range_ok.is_none() {
2026-02-21T03:50:43.7413323Z              let status = parse_http_status(&self.response_headers);
2026-02-21T03:50:43.7413727Z              let content_ok = parse_content_range(&self.response_headers)
2026-02-21T03:50:43.7414040Z -                .map(|(s, e)| {
2026-02-21T03:50:43.7414265Z -                    s == self.segment.start
2026-02-21T03:50:43.7414553Z -                        && e == self.segment.end.saturating_sub(1)
2026-02-21T03:50:43.7414830Z -                })
2026-02-21T03:50:43.7415258Z +                .map(|(s, e)| s == self.segment.start && e == self.segment.end.saturating_sub(1))
2026-02-21T03:50:43.7415657Z                  .unwrap_or(false);
2026-02-21T03:50:43.7415934Z              self.range_ok = Some(status == Some(206) && content_ok);
2026-02-21T03:50:43.7416218Z          }
2026-02-21T03:50:43.7416682Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/handler.rs:105:
2026-02-21T03:50:43.7417273Z          h.header(b"Location: http://other/\r\n");
2026-02-21T03:50:43.7417696Z          assert_eq!(h.response_headers.len(), 2);
2026-02-21T03:50:43.7418207Z          h.header(b"HTTP/1.1 206 Partial Content\r\n");
2026-02-21T03:50:43.7418799Z -        assert_eq!(h.response_headers.len(), 1, "headers cleared on new HTTP/ line");
2026-02-21T03:50:43.7419161Z +        assert_eq!(
2026-02-21T03:50:43.7419493Z +            h.response_headers.len(),
2026-02-21T03:50:43.7419869Z +            1,
2026-02-21T03:50:43.7420199Z +            "headers cleared on new HTTP/ line"
2026-02-21T03:50:43.7420457Z +        );
2026-02-21T03:50:43.7420665Z          assert!(h.response_headers[0].contains("206"));
2026-02-21T03:50:43.7420916Z      }
2026-02-21T03:50:43.7421065Z  
2026-02-21T03:50:43.7421507Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/mod.rs:16:
2026-02-21T03:50:43.7422077Z  use crate::segmenter::{Segment, SegmentBitmap};
2026-02-21T03:50:43.7422358Z  use crate::storage::StorageWriter;
2026-02-21T03:50:43.7422567Z  
2026-02-21T03:50:43.7422728Z -use super::DownloadSummary;
2026-02-21T03:50:43.7422942Z  use super::CurlOptions;
2026-02-21T03:50:43.7423261Z +use super::DownloadSummary;
2026-02-21T03:50:43.7423451Z  
2026-02-21T03:50:43.7423714Z  /// Runs segment downloads via the curl multi backend (Easy2 + Multi handle).
2026-02-21T03:50:43.7424192Z  /// When retry_policy is Some, retryable segment failures are retried with backoff.
2026-02-21T03:50:43.7424856Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/mod.rs:100:
2026-02-21T03:50:43.7425379Z              None,
2026-02-21T03:50:43.7425559Z              CurlOptions::default(),
2026-02-21T03:50:43.7425776Z          );
2026-02-21T03:50:43.7426038Z -        assert!(result.is_ok(), "multi returns Ok when no segments to download");
2026-02-21T03:50:43.7426528Z +        assert!(
2026-02-21T03:50:43.7426698Z +            result.is_ok(),
2026-02-21T03:50:43.7426940Z +            "multi returns Ok when no segments to download"
2026-02-21T03:50:43.7427206Z +        );
2026-02-21T03:50:43.7427348Z      }
2026-02-21T03:50:43.7427492Z  }
2026-02-21T03:50:43.7427627Z  
2026-02-21T03:50:43.7428099Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/refill.rs:10:
2026-02-21T03:50:43.7428640Z  use crate::segmenter::Segment;
2026-02-21T03:50:43.7428869Z  use crate::storage::StorageWriter;
2026-02-21T03:50:43.7429088Z  
2026-02-21T03:50:43.7429259Z -use super::handler::SegmentHandler;
2026-02-21T03:50:43.7429506Z  use super::super::CurlOptions;
2026-02-21T03:50:43.7429728Z +use super::handler::SegmentHandler;
2026-02-21T03:50:43.7429942Z  
2026-02-21T03:50:43.7430195Z  /// Active entry in the multi event loop: handle + segment index + metadata.
2026-02-21T03:50:43.7430556Z -pub(super) type ActiveItem =
2026-02-21T03:50:43.7430871Z -    (curl::multi::Easy2Handle<SegmentHandler>, usize, Segment, u32);
2026-02-21T03:50:43.7431203Z +pub(super) type ActiveItem = (
2026-02-21T03:50:43.7431449Z +    curl::multi::Easy2Handle<SegmentHandler>,
2026-02-21T03:50:43.7431690Z +    usize,
2026-02-21T03:50:43.7431863Z +    Segment,
2026-02-21T03:50:43.7432018Z +    u32,
2026-02-21T03:50:43.7432164Z +);
2026-02-21T03:50:43.7432300Z  
2026-02-21T03:50:43.7432551Z  /// Returns wait time in ms until the next retry is ready, capped at 100.
2026-02-21T03:50:43.7433024Z  pub(super) fn next_retry_wait_ms(retry_after: &[(Instant, usize, Segment, u32)]) -> u64 {
2026-02-21T03:50:43.7433942Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/refill.rs:47:
2026-02-21T03:50:43.7434519Z          in_flight_bytes.map(Arc::clone),
2026-02-21T03:50:43.7434745Z      );
2026-02-21T03:50:43.7434943Z      let mut easy = curl::easy::Easy2::new(handler);
2026-02-21T03:50:43.7435284Z -    easy.url(url).map_err(|e| anyhow::anyhow!("curl url: {}", e))?;
2026-02-21T03:50:43.7435592Z +    easy.url(url)
2026-02-21T03:50:43.7435812Z +        .map_err(|e| anyhow::anyhow!("curl url: {}", e))?;
2026-02-21T03:50:43.7436101Z      easy.follow_location(true)
2026-02-21T03:50:43.7436345Z          .map_err(|e| anyhow::anyhow!("curl: {}", e))?;
2026-02-21T03:50:43.7436615Z      easy.max_redirections(10)
2026-02-21T03:50:43.7437130Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/refill.rs:132:
2026-02-21T03:50:43.7437653Z      }
2026-02-21T03:50:43.7437799Z      Ok(())
2026-02-21T03:50:43.7437945Z  }
2026-02-21T03:50:43.7438088Z -
2026-02-21T03:50:43.7438221Z  
2026-02-21T03:50:43.7438661Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/result.rs:3:
2026-02-21T03:50:43.7439198Z  use crate::retry::SegmentError;
2026-02-21T03:50:43.7439425Z  use crate::segmenter::Segment;
2026-02-21T03:50:43.7439630Z  
2026-02-21T03:50:43.7439885Z -use super::handler::SegmentHandler;
2026-02-21T03:50:43.7440327Z  use super::super::SegmentResult;
2026-02-21T03:50:43.7440733Z +use super::handler::SegmentHandler;
2026-02-21T03:50:43.7441104Z  
2026-02-21T03:50:43.7441441Z  /// Build result from response code and handler bytes_written.
2026-02-21T03:50:43.7441772Z  pub(super) fn segment_result_from_easy(
2026-02-21T03:50:43.7442371Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:12:
2026-02-21T03:50:43.7442936Z  use crate::segmenter::{Segment, SegmentBitmap};
2026-02-21T03:50:43.7443324Z  use crate::storage::StorageWriter;
2026-02-21T03:50:43.7443536Z  
2026-02-21T03:50:43.7443696Z +use super::super::CurlOptions;
2026-02-21T03:50:43.7443916Z +use super::super::DownloadSummary;
2026-02-21T03:50:43.7444156Z  use super::handler::SegmentHandler;
2026-02-21T03:50:43.7444380Z  use super::refill;
2026-02-21T03:50:43.7444773Z  use super::result;
2026-02-21T03:50:43.7445235Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:18:
2026-02-21T03:50:43.7445766Z -use super::super::DownloadSummary;
2026-02-21T03:50:43.7446008Z -use super::super::CurlOptions;
2026-02-21T03:50:43.7446203Z  
2026-02-21T03:50:43.7446376Z  const COALESCE_PROGRESS_EVERY: usize = 2;
2026-02-21T03:50:43.7446604Z  
2026-02-21T03:50:43.7447031Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:45:
2026-02-21T03:50:43.7447569Z      let multi = curl::multi::Multi::new();
2026-02-21T03:50:43.7447936Z      let mut pending: VecDeque<(usize, Segment)> = incomplete.into_iter().collect();
2026-02-21T03:50:43.7448401Z      let mut retry_after: Vec<(Instant, usize, Segment, u32)> = Vec::new();
2026-02-21T03:50:43.7448910Z -    let mut active: Vec<(curl::multi::Easy2Handle<SegmentHandler>, usize, Segment, u32)> = Vec::new();
2026-02-21T03:50:43.7449343Z +    let mut active: Vec<(
2026-02-21T03:50:43.7449571Z +        curl::multi::Easy2Handle<SegmentHandler>,
2026-02-21T03:50:43.7449830Z +        usize,
2026-02-21T03:50:43.7449997Z +        Segment,
2026-02-21T03:50:43.7450155Z +        u32,
2026-02-21T03:50:43.7450322Z +    )> = Vec::new();
2026-02-21T03:50:43.7450555Z      let mut first_error: Option<anyhow::Error> = None;
2026-02-21T03:50:43.7450853Z      let mut completed_since_send = 0usize;
2026-02-21T03:50:43.7451083Z  
2026-02-21T03:50:43.7451535Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:67:
2026-02-21T03:50:43.7452045Z      }
2026-02-21T03:50:43.7452317Z  
2026-02-21T03:50:43.7452484Z      while !active.is_empty() {
2026-02-21T03:50:43.7452819Z -        if abort.as_ref().map(|a| a.load(Ordering::Relaxed)).unwrap_or(false) {
2026-02-21T03:50:43.7453380Z +        if abort
2026-02-21T03:50:43.7453564Z +            .as_ref()
2026-02-21T03:50:43.7453779Z +            .map(|a| a.load(Ordering::Relaxed))
2026-02-21T03:50:43.7454038Z +            .unwrap_or(false)
2026-02-21T03:50:43.7454240Z +        {
2026-02-21T03:50:43.7454404Z              if first_error.is_none() {
2026-02-21T03:50:43.7454694Z                  first_error = Some(anyhow::anyhow!(JobAborted));
2026-02-21T03:50:43.7454967Z              }
2026-02-21T03:50:43.7455424Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:74:
2026-02-21T03:50:43.7455942Z              break;
2026-02-21T03:50:43.7456101Z          }
2026-02-21T03:50:43.7456430Z -        let running = multi.perform().map_err(|e| anyhow::anyhow!("curl multi perform: {}", e))?;
2026-02-21T03:50:43.7456830Z +        let running = multi
2026-02-21T03:50:43.7457034Z +            .perform()
2026-02-21T03:50:43.7457292Z +            .map_err(|e| anyhow::anyhow!("curl multi perform: {}", e))?;
2026-02-21T03:50:43.7457928Z          let mut completed_indices: Vec<usize> = Vec::new();
2026-02-21T03:50:43.7458420Z          multi.messages(|msg| {
2026-02-21T03:50:43.7458838Z              for (i, (ref handle, ..)) in active.iter().enumerate() {
2026-02-21T03:50:43.7459419Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:86:
2026-02-21T03:50:43.7459975Z          completed_indices.sort_by(|a, b| b.cmp(a));
2026-02-21T03:50:43.7460252Z          for &i in &completed_indices {
2026-02-21T03:50:43.7460559Z              let (handle, seg_index, segment, attempt) = active.remove(i);
2026-02-21T03:50:43.7461060Z -            let mut easy = multi.remove2(handle).map_err(|e| anyhow::anyhow!("curl multi remove: {}", e))?;
2026-02-21T03:50:43.7461488Z +            let mut easy = multi
2026-02-21T03:50:43.7461700Z +                .remove2(handle)
2026-02-21T03:50:43.7461984Z +                .map_err(|e| anyhow::anyhow!("curl multi remove: {}", e))?;
2026-02-21T03:50:43.7462328Z              let code = easy.response_code().unwrap_or(0);
2026-02-21T03:50:43.7462764Z              let handler = easy.get_mut();
2026-02-21T03:50:43.7463207Z              let res = result::segment_result_from_easy(code, &segment, handler);
2026-02-21T03:50:43.7463832Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:110:
2026-02-21T03:50:43.7464354Z                      }
2026-02-21T03:50:43.7464609Z                      let will_retry = retry_policy.as_ref().and_then(|policy| {
2026-02-21T03:50:43.7464966Z                          match policy.decide(attempt, kind) {
2026-02-21T03:50:43.7465433Z -                            RetryDecision::RetryAfter(d) => Some((Instant::now() + d, seg_index, segment, attempt + 1)),
2026-02-21T03:50:43.7465908Z +                            RetryDecision::RetryAfter(d) => {
2026-02-21T03:50:43.7466256Z +                                Some((Instant::now() + d, seg_index, segment, attempt + 1))
2026-02-21T03:50:43.7466587Z +                            }
2026-02-21T03:50:43.7466828Z                              RetryDecision::NoRetry => None,
2026-02-21T03:50:43.7467080Z                          }
2026-02-21T03:50:43.7467264Z                      });
2026-02-21T03:50:43.7467737Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:118:
2026-02-21T03:50:43.7468283Z                          retry_after.push(entry);
2026-02-21T03:50:43.7468525Z                      } else {
2026-02-21T03:50:43.7468753Z                          if first_error.is_none() {
2026-02-21T03:50:43.7469284Z -                            first_error = Some(anyhow::anyhow!("{}", e).context(format!("segment {}", seg_index)));
2026-02-21T03:50:43.7469733Z +                            first_error = Some(
2026-02-21T03:50:43.7470096Z +                                anyhow::anyhow!("{}", e).context(format!("segment {}", seg_index)),
2026-02-21T03:50:43.7470446Z +                            );
2026-02-21T03:50:43.7470650Z                          }
2026-02-21T03:50:43.7470833Z                      }
2026-02-21T03:50:43.7471004Z                  }
2026-02-21T03:50:43.7471459Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/multi/run.rs:141:
2026-02-21T03:50:43.7471974Z          }
2026-02-21T03:50:43.7472134Z          if running > 0 {
2026-02-21T03:50:43.7472408Z              let wait_ms = refill::next_retry_wait_ms(&retry_after).min(100);
2026-02-21T03:50:43.7472784Z -            multi.wait(&mut [], Duration::from_millis(wait_ms))
2026-02-21T03:50:43.7473061Z +            multi
2026-02-21T03:50:43.7473389Z +                .wait(&mut [], Duration::from_millis(wait_ms))
2026-02-21T03:50:43.7473737Z                  .map_err(|e| anyhow::anyhow!("curl multi wait: {}", e))?;
2026-02-21T03:50:43.7474030Z          }
2026-02-21T03:50:43.7474179Z      }
2026-02-21T03:50:43.7474667Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run/unbounded.rs:4:
2026-02-21T03:50:43.7475204Z  use std::sync::Arc;
2026-02-21T03:50:43.7475371Z  
2026-02-21T03:50:43.7475536Z  use crate::control::JobAborted;
2026-02-21T03:50:43.7475865Z -use crate::downloader::{CurlOptions, DownloadSummary, SegmentResult};
2026-02-21T03:50:43.7476214Z  use crate::downloader::segment;
2026-02-21T03:50:43.7476525Z +use crate::downloader::{CurlOptions, DownloadSummary, SegmentResult};
2026-02-21T03:50:43.7476936Z  use crate::retry::{classify, run_with_retry, ErrorKind, RetryPolicy};
2026-02-21T03:50:43.7477295Z  use crate::segmenter::{Segment, SegmentBitmap};
2026-02-21T03:50:43.7477569Z  use crate::storage::StorageWriter;
2026-02-21T03:50:43.7478108Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run/unbounded.rs:25:
2026-02-21T03:50:43.7478695Z      abort: Option<Arc<std::sync::atomic::AtomicBool>>,
2026-02-21T03:50:43.7478962Z      curl: CurlOptions,
2026-02-21T03:50:43.7479153Z  ) -> Result<()> {
2026-02-21T03:50:43.7479554Z -    if abort.as_ref().map(|a| a.load(Ordering::Relaxed)).unwrap_or(false) {
2026-02-21T03:50:43.7479881Z +    if abort
2026-02-21T03:50:43.7480033Z +        .as_ref()
2026-02-21T03:50:43.7480228Z +        .map(|a| a.load(Ordering::Relaxed))
2026-02-21T03:50:43.7480465Z +        .unwrap_or(false)
2026-02-21T03:50:43.7480651Z +    {
2026-02-21T03:50:43.7480841Z          return Err(anyhow::anyhow!(JobAborted));
2026-02-21T03:50:43.7481081Z      }
2026-02-21T03:50:43.7481267Z      type JoinErr = Box<dyn std::any::Any + Send>;
2026-02-21T03:50:43.7482105Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run/unbounded.rs:38:
2026-02-21T03:50:43.7483182Z              let policy = retry_policy.clone();
2026-02-21T03:50:43.7483449Z              let curl_opts = curl;
2026-02-21T03:50:43.7483795Z              let in_flight = in_flight_bytes.as_ref().map(|v| (Arc::clone(v), index));
2026-02-21T03:50:43.7484167Z -            std::thread::spawn(move || {
2026-02-21T03:50:43.7484419Z -                match policy.as_ref() {
2026-02-21T03:50:43.7484694Z -                    Some(p) => run_with_retry(p, || {
2026-02-21T03:50:43.7485118Z -                        segment::download_one_segment(&u, &h, &segment, &st, in_flight.clone(), curl_opts)
2026-02-21T03:50:43.7485520Z -                    }),
2026-02-21T03:50:43.7485862Z -                    None => segment::download_one_segment(&u, &h, &segment, &st, in_flight, curl_opts),
2026-02-21T03:50:43.7486243Z -                }
2026-02-21T03:50:43.7486467Z +            std::thread::spawn(move || match policy.as_ref() {
2026-02-21T03:50:43.7486773Z +                Some(p) => run_with_retry(p, || {
2026-02-21T03:50:43.7487174Z +                    segment::download_one_segment(
2026-02-21T03:50:43.7487429Z +                        &u,
2026-02-21T03:50:43.7487633Z +                        &h,
2026-02-21T03:50:43.7487824Z +                        &segment,
2026-02-21T03:50:43.7488034Z +                        &st,
2026-02-21T03:50:43.7488246Z +                        in_flight.clone(),
2026-02-21T03:50:43.7488482Z +                        curl_opts,
2026-02-21T03:50:43.7488686Z +                    )
2026-02-21T03:50:43.7488857Z +                }),
2026-02-21T03:50:43.7489181Z +                None => segment::download_one_segment(&u, &h, &segment, &st, in_flight, curl_opts),
2026-02-21T03:50:43.7489552Z              })
2026-02-21T03:50:43.7489716Z              .join()
2026-02-21T03:50:43.7489897Z              .map(|res| (index, res))
2026-02-21T03:50:43.7490429Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run/unbounded.rs:82:
2026-02-21T03:50:43.7490991Z                      summary_out.error_events += 1;
2026-02-21T03:50:43.7491236Z                  }
2026-02-21T03:50:43.7491412Z                  if first_error.is_none() {
2026-02-21T03:50:43.7491802Z -                    first_error = Some(anyhow::anyhow!("{}", e).context(format!("segment {}", index)));
2026-02-21T03:50:43.7492198Z +                    first_error =
2026-02-21T03:50:43.7492515Z +                        Some(anyhow::anyhow!("{}", e).context(format!("segment {}", index)));
2026-02-21T03:50:43.7492854Z                  }
2026-02-21T03:50:43.7493010Z              }
2026-02-21T03:50:43.7493378Z          }
2026-02-21T03:50:43.7493852Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run/unbounded.rs:97:
2026-02-21T03:50:43.7494392Z      }
2026-02-21T03:50:43.7494536Z      Ok(())
2026-02-21T03:50:43.7494687Z  }
2026-02-21T03:50:43.7494826Z -
2026-02-21T03:50:43.7494973Z  
2026-02-21T03:50:43.7495446Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run.rs:10:
2026-02-21T03:50:43.7496001Z  use crate::segmenter::{Segment, SegmentBitmap};
2026-02-21T03:50:43.7496288Z  use crate::storage::StorageWriter;
2026-02-21T03:50:43.7496511Z  
2026-02-21T03:50:43.7496671Z -use crate::control::JobAborted;
2026-02-21T03:50:43.7497025Z  use super::segment;
2026-02-21T03:50:43.7497215Z  use super::CurlOptions;
2026-02-21T03:50:43.7497426Z  use super::DownloadSummary;
2026-02-21T03:50:43.7497900Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run.rs:17:
2026-02-21T03:50:43.7498418Z  use super::SegmentResult;
2026-02-21T03:50:43.7498634Z +use crate::control::JobAborted;
2026-02-21T03:50:43.7498846Z  
2026-02-21T03:50:43.7498994Z  mod unbounded;
2026-02-21T03:50:43.7499191Z  pub(super) use unbounded::run_unbounded;
2026-02-21T03:50:43.7499711Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run.rs:57:
2026-02-21T03:50:43.7500224Z          let policy = retry_policy;
2026-02-21T03:50:43.7500454Z          let curl_opts = curl;
2026-02-21T03:50:43.7500728Z          let in_flight = in_flight_bytes.as_ref().map(Arc::clone);
2026-02-21T03:50:43.7501060Z -        handles.push(std::thread::spawn(move || {
2026-02-21T03:50:43.7501318Z -            loop {
2026-02-21T03:50:43.7501621Z -                if abort.load(Ordering::Relaxed) || user_abort.load(Ordering::Relaxed) {
2026-02-21T03:50:43.7501982Z -                    break;
2026-02-21T03:50:43.7502165Z -                }
2026-02-21T03:50:43.7502426Z -                let (index, segment) = match work.lock().unwrap().pop_front() {
2026-02-21T03:50:43.7502755Z -                    Some(p) => p,
2026-02-21T03:50:43.7502972Z -                    None => break,
2026-02-21T03:50:43.7503283Z -                };
2026-02-21T03:50:43.7503758Z -                let in_flight_seg = in_flight.as_ref().map(|v| (Arc::clone(v), index));
2026-02-21T03:50:43.7504611Z -                let res: SegmentResult = match policy.as_ref() {
2026-02-21T03:50:43.7505003Z -                    Some(p) => run_with_retry(p, || {
2026-02-21T03:50:43.7505439Z -                        segment::download_one_segment(&u, &h, &segment, &st, in_flight_seg.clone(), curl_opts)
2026-02-21T03:50:43.7505848Z -                    }),
2026-02-21T03:50:43.7506213Z -                    None => segment::download_one_segment(&u, &h, &segment, &st, in_flight_seg, curl_opts),
2026-02-21T03:50:43.7506602Z -                };
2026-02-21T03:50:43.7506794Z -                let _ = tx.send((index, res));
2026-02-21T03:50:43.7507082Z +        handles.push(std::thread::spawn(move || loop {
2026-02-21T03:50:43.7507469Z +            if abort.load(Ordering::Relaxed) || user_abort.load(Ordering::Relaxed) {
2026-02-21T03:50:43.7507821Z +                break;
2026-02-21T03:50:43.7507994Z              }
2026-02-21T03:50:43.7508249Z +            let (index, segment) = match work.lock().unwrap().pop_front() {
2026-02-21T03:50:43.7508575Z +                Some(p) => p,
2026-02-21T03:50:43.7508783Z +                None => break,
2026-02-21T03:50:43.7508976Z +            };
2026-02-21T03:50:43.7509253Z +            let in_flight_seg = in_flight.as_ref().map(|v| (Arc::clone(v), index));
2026-02-21T03:50:43.7509637Z +            let res: SegmentResult = match policy.as_ref() {
2026-02-21T03:50:43.7509944Z +                Some(p) => run_with_retry(p, || {
2026-02-21T03:50:43.7510217Z +                    segment::download_one_segment(
2026-02-21T03:50:43.7510461Z +                        &u,
2026-02-21T03:50:43.7510755Z +                        &h,
2026-02-21T03:50:43.7511085Z +                        &segment,
2026-02-21T03:50:43.7511439Z +                        &st,
2026-02-21T03:50:43.7511771Z +                        in_flight_seg.clone(),
2026-02-21T03:50:43.7512020Z +                        curl_opts,
2026-02-21T03:50:43.7512227Z +                    )
2026-02-21T03:50:43.7512400Z +                }),
2026-02-21T03:50:43.7512581Z +                None => {
2026-02-21T03:50:43.7512921Z +                    segment::download_one_segment(&u, &h, &segment, &st, in_flight_seg, curl_opts)
2026-02-21T03:50:43.7513424Z +                }
2026-02-21T03:50:43.7513586Z +            };
2026-02-21T03:50:43.7513999Z +            let _ = tx.send((index, res));
2026-02-21T03:50:43.7514469Z          }));
2026-02-21T03:50:43.7514723Z      }
2026-02-21T03:50:43.7515031Z      drop(tx);
2026-02-21T03:50:43.7515544Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run.rs:124:
2026-02-21T03:50:43.7516213Z                      to_receive = to_receive.saturating_sub(drained);
2026-02-21T03:50:43.7516639Z                  }
2026-02-21T03:50:43.7516883Z                  if first_error.is_none() {
2026-02-21T03:50:43.7517406Z -                    first_error = Some(anyhow::anyhow!("{}", e).context(format!("segment {}", index)));
2026-02-21T03:50:43.7527876Z +                    first_error =
2026-02-21T03:50:43.7528477Z +                        Some(anyhow::anyhow!("{}", e).context(format!("segment {}", index)));
2026-02-21T03:50:43.7529035Z                  }
2026-02-21T03:50:43.7529219Z              }
2026-02-21T03:50:43.7529381Z          }
2026-02-21T03:50:43.7529824Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/run.rs:152:
2026-02-21T03:50:43.7530341Z      }
2026-02-21T03:50:43.7530498Z      Ok(())
2026-02-21T03:50:43.7530647Z  }
2026-02-21T03:50:43.7530791Z +
2026-02-21T03:50:43.7531289Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/segment.rs:5:
2026-02-21T03:50:43.7531939Z  //! full body (which would corrupt the temp file when written at segment offset).
2026-02-21T03:50:43.7532424Z  //! Validation is done in the write callback before writing any byte (pre-write).
2026-02-21T03:50:43.7532794Z  
2026-02-21T03:50:43.7533238Z +use super::CurlOptions;
2026-02-21T03:50:43.7533820Z  use crate::retry::SegmentError;
2026-02-21T03:50:43.7534184Z  use crate::segmenter::Segment;
2026-02-21T03:50:43.7534430Z  use crate::storage::StorageWriter;
2026-02-21T03:50:43.7534960Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/segment.rs:11:
2026-02-21T03:50:43.7535492Z -use super::CurlOptions;
2026-02-21T03:50:43.7535714Z  use std::collections::HashMap;
2026-02-21T03:50:43.7535922Z  use std::str;
2026-02-21T03:50:43.7536128Z  use std::sync::atomic::{AtomicU64, Ordering};
2026-02-21T03:50:43.7536654Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/segment.rs:86:
2026-02-21T03:50:43.7537172Z                          vec.clear();
2026-02-21T03:50:43.7537424Z                          vec.push(line.to_string());
2026-02-21T03:50:43.7537681Z                      } else {
2026-02-21T03:50:43.7538020Z -                        let _ = response_headers_header.lock().unwrap().push(line.to_string());
2026-02-21T03:50:43.7538429Z +                        let _ = response_headers_header
2026-02-21T03:50:43.7538698Z +                            .lock()
2026-02-21T03:50:43.7538921Z +                            .unwrap()
2026-02-21T03:50:43.7539169Z +                            .push(line.to_string());
2026-02-21T03:50:43.7539406Z                      }
2026-02-21T03:50:43.7539588Z                  }
2026-02-21T03:50:43.7539753Z                  true
2026-02-21T03:50:43.7540228Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/segment.rs:109:
2026-02-21T03:50:43.7540740Z                  }
2026-02-21T03:50:43.7541052Z                  let off = bytes_written_in_cb.fetch_add(data.len() as u64, Ordering::Relaxed);
2026-02-21T03:50:43.7541456Z                  if let Some((ref v, idx)) = in_flight {
2026-02-21T03:50:43.7541935Z -                    v.get(idx).map(|a| a.store(bytes_written_in_cb.load(Ordering::Relaxed), Ordering::Relaxed));
2026-02-21T03:50:43.7542371Z +                    v.get(idx).map(|a| {
2026-02-21T03:50:43.7542608Z +                        a.store(
2026-02-21T03:50:43.7542869Z +                            bytes_written_in_cb.load(Ordering::Relaxed),
2026-02-21T03:50:43.7543365Z +                            Ordering::Relaxed,
2026-02-21T03:50:43.7543606Z +                        )
2026-02-21T03:50:43.7543934Z +                    });
2026-02-21T03:50:43.7544110Z                  }
2026-02-21T03:50:43.7544348Z                  match storage.write_at(segment_start + off, data) {
2026-02-21T03:50:43.7544644Z                      Ok(()) => Ok(data.len()),
2026-02-21T03:50:43.7545165Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/segment.rs:116:
2026-02-21T03:50:43.7545684Z                      Err(e) => {
2026-02-21T03:50:43.7545897Z -                        let io_err = e
2026-02-21T03:50:43.7546158Z -                            .downcast::<std::io::Error>()
2026-02-21T03:50:43.7546571Z -                            .unwrap_or_else(|e| std::io::Error::new(std::io::ErrorKind::Other, e.to_string()));
2026-02-21T03:50:43.7547058Z +                        let io_err = e.downcast::<std::io::Error>().unwrap_or_else(|e| {
2026-02-21T03:50:43.7547466Z +                            std::io::Error::new(std::io::ErrorKind::Other, e.to_string())
2026-02-21T03:50:43.7547792Z +                        });
2026-02-21T03:50:43.7548068Z                          let _ = storage_error_cb.lock().unwrap().replace(io_err);
2026-02-21T03:50:43.7548373Z                          Ok(0)
2026-02-21T03:50:43.7548567Z                      }
2026-02-21T03:50:43.7549011Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/single.rs:2:
2026-02-21T03:50:43.7549508Z  //!
2026-02-21T03:50:43.7549767Z  //! Writes the response body sequentially to storage starting at offset 0.
2026-02-21T03:50:43.7550105Z  
2026-02-21T03:50:43.7550265Z -use anyhow::{Context, Result};
2026-02-21T03:50:43.7550612Z -use crate::storage::StorageWriter;
2026-02-21T03:50:43.7550872Z  use super::CurlOptions;
2026-02-21T03:50:43.7551080Z +use crate::storage::StorageWriter;
2026-02-21T03:50:43.7551314Z +use anyhow::{Context, Result};
2026-02-21T03:50:43.7551531Z  use std::collections::HashMap;
2026-02-21T03:50:43.7551740Z  use std::str;
2026-02-21T03:50:43.7551945Z  use std::sync::atomic::{AtomicU64, Ordering};
2026-02-21T03:50:43.7552481Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/single.rs:29:
2026-02-21T03:50:43.7552996Z      easy.follow_location(true)?;
2026-02-21T03:50:43.7553401Z      easy.max_redirections(10)?;
2026-02-21T03:50:43.7553657Z      if let Some(speed) = curl.max_recv_speed {
2026-02-21T03:50:43.7554019Z -        easy.max_recv_speed(speed).map_err(|e| anyhow::anyhow!("curl: {}", e))?;
2026-02-21T03:50:43.7554378Z +        easy.max_recv_speed(speed)
2026-02-21T03:50:43.7554638Z +            .map_err(|e| anyhow::anyhow!("curl: {}", e))?;
2026-02-21T03:50:43.7554906Z      }
2026-02-21T03:50:43.7555079Z      if let Some(sz) = curl.buffer_size {
2026-02-21T03:50:43.7555415Z -        easy.buffer_size(sz).map_err(|e| anyhow::anyhow!("curl: {}", e))?;
2026-02-21T03:50:43.7555743Z +        easy.buffer_size(sz)
2026-02-21T03:50:43.7555992Z +            .map_err(|e| anyhow::anyhow!("curl: {}", e))?;
2026-02-21T03:50:43.7556252Z      }
2026-02-21T03:50:43.7556448Z      easy.connect_timeout(Duration::from_secs(30))?;
2026-02-21T03:50:43.7556823Z -    easy.low_speed_limit(1024).map_err(|e| anyhow::anyhow!("curl: {}", e))?;
2026-02-21T03:50:43.7557162Z +    easy.low_speed_limit(1024)
2026-02-21T03:50:43.7557411Z +        .map_err(|e| anyhow::anyhow!("curl: {}", e))?;
2026-02-21T03:50:43.7557707Z      easy.low_speed_time(Duration::from_secs(60))?;
2026-02-21T03:50:43.7557991Z      easy.timeout(Duration::from_secs(3600))?;
2026-02-21T03:50:43.7558221Z  
2026-02-21T03:50:43.7558654Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/downloader/single.rs:81:
2026-02-21T03:50:43.7559157Z      }
2026-02-21T03:50:43.7559301Z      Ok(written)
2026-02-21T03:50:43.7559463Z  }
2026-02-21T03:50:43.7559598Z -
2026-02-21T03:50:43.7559741Z  
2026-02-21T03:50:43.7560267Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/fetch_head/mod.rs:47:
2026-02-21T03:50:43.7561383Z      let mut headers: Vec<String> = Vec::new();
2026-02-21T03:50:43.7561652Z  
2026-02-21T03:50:43.7561825Z      let mut easy = curl::easy::Easy::new();
2026-02-21T03:50:43.7562063Z -    easy.url(url)
2026-02-21T03:50:43.7562245Z -        .context("invalid URL")?;
2026-02-21T03:50:43.7562488Z +    easy.url(url).context("invalid URL")?;
2026-02-21T03:50:43.7562731Z      easy.nobody(true)?; // HEAD request
2026-02-21T03:50:43.7562973Z      easy.follow_location(true)?;
2026-02-21T03:50:43.7563369Z      easy.max_redirections(10)?;
2026-02-21T03:50:43.7563861Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/fetch_head/mod.rs:157:
2026-02-21T03:50:43.7564402Z  /// - If HEAD fails, falls back to `probe_range0`.
2026-02-21T03:50:43.7564795Z  /// - If HEAD succeeds but doesn't provide enough info (no ranges or no length),
2026-02-21T03:50:43.7565200Z  ///   also tries `probe_range0` and merges the results.
2026-02-21T03:50:43.7565668Z -pub fn probe_best_effort(url: &str, custom_headers: &HashMap<String, String>) -> Result<HeadResult> {
2026-02-21T03:50:43.7566109Z +pub fn probe_best_effort(
2026-02-21T03:50:43.7566301Z +    url: &str,
2026-02-21T03:50:43.7566496Z +    custom_headers: &HashMap<String, String>,
2026-02-21T03:50:43.7566826Z +) -> Result<HeadResult> {
2026-02-21T03:50:43.7567195Z      let head = probe(url, custom_headers);
2026-02-21T03:50:43.7567594Z      match head {
2026-02-21T03:50:43.7567812Z          Ok(mut r) => {
2026-02-21T03:50:43.7568272Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/fetch_head/parse.rs:93:
2026-02-21T03:50:43.7568896Z  
2026-02-21T03:50:43.7569055Z      #[test]
2026-02-21T03:50:43.7569248Z      fn parse_headers_content_disposition() {
2026-02-21T03:50:43.7569501Z -        let lines = [
2026-02-21T03:50:43.7569823Z -            "Content-Disposition: attachment; filename=\"report.pdf\"".to_string(),
2026-02-21T03:50:43.7570189Z -        ];
2026-02-21T03:50:43.7570507Z +        let lines = ["Content-Disposition: attachment; filename=\"report.pdf\"".to_string()];
2026-02-21T03:50:43.7570931Z          let r = parse_headers(&lines).unwrap();
2026-02-21T03:50:43.7571211Z          assert!(r.content_disposition.is_some());
2026-02-21T03:50:43.7571583Z -        assert!(r.content_disposition.as_deref().unwrap().contains("report.pdf"));
2026-02-21T03:50:43.7571933Z +        assert!(r
2026-02-21T03:50:43.7572116Z +            .content_disposition
2026-02-21T03:50:43.7572322Z +            .as_deref()
2026-02-21T03:50:43.7572501Z +            .unwrap()
2026-02-21T03:50:43.7572691Z +            .contains("report.pdf"));
2026-02-21T03:50:43.7572915Z      }
2026-02-21T03:50:43.7573055Z  }
2026-02-21T03:50:43.7573475Z  
2026-02-21T03:50:43.7574216Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/har/mod.rs:81:
2026-02-21T03:50:43.7574720Z          f.flush().unwrap();
2026-02-21T03:50:43.7574969Z          let spec = resolve_har(f.path(), true).unwrap();
2026-02-21T03:50:43.7575336Z          assert_eq!(spec.url, "https://cdn.example.com/file.zip");
2026-02-21T03:50:43.7575803Z -        assert_eq!(spec.headers.get("Cookie").map(|s| s.as_str()), Some("session=abc123"));
2026-02-21T03:50:43.7576178Z +        assert_eq!(
2026-02-21T03:50:43.7576401Z +            spec.headers.get("Cookie").map(|s| s.as_str()),
2026-02-21T03:50:43.7576681Z +            Some("session=abc123")
2026-02-21T03:50:43.7576892Z +        );
2026-02-21T03:50:43.7577042Z      }
2026-02-21T03:50:43.7577182Z  
2026-02-21T03:50:43.7577324Z      #[test]
2026-02-21T03:50:43.7577879Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/har/resolve.rs:18:
2026-02-21T03:50:43.7578643Z  /// If `include_cookies` is true, the `Cookie` header from the chosen request
2026-02-21T03:50:43.7579007Z  /// is included (for cookie-based CDN auth).
2026-02-21T03:50:43.7579389Z  pub fn resolve_har(path: &Path, include_cookies: bool) -> Result<ResolvedJobSpec> {
2026-02-21T03:50:43.7579942Z -    let bytes = std::fs::read(path)
2026-02-21T03:50:43.7580254Z -        .with_context(|| format!("read HAR file: {}", path.display()))?;
2026-02-21T03:50:43.7580574Z +    let bytes =
2026-02-21T03:50:43.7580903Z +        std::fs::read(path).with_context(|| format!("read HAR file: {}", path.display()))?;
2026-02-21T03:50:43.7581317Z      let har: HarLog = serde_json::from_slice(&bytes)
2026-02-21T03:50:43.7581665Z          .with_context(|| format!("parse HAR JSON: {}", path.display()))?;
2026-02-21T03:50:43.7582006Z  
2026-02-21T03:50:43.7582725Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/har/resolve.rs:28:
2026-02-21T03:50:43.7583796Z          anyhow::bail!("HAR file has no entries");
2026-02-21T03:50:43.7584091Z      }
2026-02-21T03:50:43.7584235Z  
2026-02-21T03:50:43.7584493Z -    let best_index = select_download_entry(&entries).unwrap_or_else(|| {
2026-02-21T03:50:43.7584891Z -        let mut final_url = entries[0].request.url.clone();
2026-02-21T03:50:43.7585189Z -        for entry in &entries {
2026-02-21T03:50:43.7585437Z -            let status = entry.response.status;
2026-02-21T03:50:43.7585773Z -            if (301..=302).contains(&status) || status == 307 || status == 308 {
2026-02-21T03:50:43.7586110Z -                if let Some(url) = entry
2026-02-21T03:50:43.7586338Z -                    .response
2026-02-21T03:50:43.7586546Z -                    .redirect_url
2026-02-21T03:50:43.7586752Z -                    .clone()
2026-02-21T03:50:43.7587103Z -                    .or_else(|| get_header(&entry.response.headers, "Location").map(String::from))
2026-02-21T03:50:43.7587626Z -                {
2026-02-21T03:50:43.7587841Z -                    final_url = url.trim().to_string();
2026-02-21T03:50:43.7588117Z +    let best_index =
2026-02-21T03:50:43.7588361Z +        select_download_entry(&entries).unwrap_or_else(|| {
2026-02-21T03:50:43.7588693Z +            let mut final_url = entries[0].request.url.clone();
2026-02-21T03:50:43.7588991Z +            for entry in &entries {
2026-02-21T03:50:43.7589240Z +                let status = entry.response.status;
2026-02-21T03:50:43.7589583Z +                if (301..=302).contains(&status) || status == 307 || status == 308 {
2026-02-21T03:50:43.7590155Z +                    if let Some(url) = entry.response.redirect_url.clone().or_else(|| {
2026-02-21T03:50:43.7590691Z +                        get_header(&entry.response.headers, "Location").map(String::from)
2026-02-21T03:50:43.7591034Z +                    }) {
2026-02-21T03:50:43.7591249Z +                        final_url = url.trim().to_string();
2026-02-21T03:50:43.7591504Z +                    }
2026-02-21T03:50:43.7591674Z                  }
2026-02-21T03:50:43.7591832Z              }
2026-02-21T03:50:43.7591982Z -        }
2026-02-21T03:50:43.7592133Z -        entries
2026-02-21T03:50:43.7592290Z -            .iter()
2026-02-21T03:50:43.7592462Z -            .enumerate()
2026-02-21T03:50:43.7592645Z -            .rev()
2026-02-21T03:50:43.7592853Z -            .find(|(_, e)| e.request.url == final_url)
2026-02-21T03:50:43.7593282Z -            .map(|(i, _)| i)
2026-02-21T03:50:43.7593544Z -            .unwrap_or(0)
2026-02-21T03:50:43.7593735Z -    });
2026-02-21T03:50:43.7593886Z +            entries
2026-02-21T03:50:43.7594054Z +                .iter()
2026-02-21T03:50:43.7594235Z +                .enumerate()
2026-02-21T03:50:43.7594424Z +                .rev()
2026-02-21T03:50:43.7594634Z +                .find(|(_, e)| e.request.url == final_url)
2026-02-21T03:50:43.7594904Z +                .map(|(i, _)| i)
2026-02-21T03:50:43.7595115Z +                .unwrap_or(0)
2026-02-21T03:50:43.7595305Z +        });
2026-02-21T03:50:43.7595456Z  
2026-02-21T03:50:43.7595657Z      let entry = &entries[best_index];
2026-02-21T03:50:43.7596100Z      let final_url = entry.request.url.clone();
2026-02-21T03:50:43.7596619Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/har/resolve.rs:83:
2026-02-21T03:50:43.7597402Z      let has_accept_ranges = get_header(&entry.response.headers, "Accept-Ranges")
2026-02-21T03:50:43.7597790Z          .map(|v| v.eq_ignore_ascii_case("bytes"))
2026-02-21T03:50:43.7598045Z          .unwrap_or(false);
2026-02-21T03:50:43.7598227Z -    (
2026-02-21T03:50:43.7598399Z -        entry.response.status == 206,
2026-02-21T03:50:43.7598638Z -        has_accept_ranges,
2026-02-21T03:50:43.7598821Z -        index,
2026-02-21T03:50:43.7598974Z -    )
2026-02-21T03:50:43.7599185Z +    (entry.response.status == 206, has_accept_ranges, index)
2026-02-21T03:50:43.7599468Z  }
2026-02-21T03:50:43.7599603Z  
2026-02-21T03:50:43.7599834Z  /// Best entry that looks like a download, or None if none match.
2026-02-21T03:50:43.7600404Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/key.rs:46:
2026-02-21T03:50:43.7600918Z              .port_or_known_default()
2026-02-21T03:50:43.7601280Z              .ok_or_else(|| anyhow::anyhow!("URL missing port and unknown default: {url}"))?;
2026-02-21T03:50:43.7601638Z  
2026-02-21T03:50:43.7601780Z -        Ok(Self {
2026-02-21T03:50:43.7601939Z -            scheme,
2026-02-21T03:50:43.7602104Z -            host,
2026-02-21T03:50:43.7602257Z -            port,
2026-02-21T03:50:43.7602413Z -        })
2026-02-21T03:50:43.7602578Z +        Ok(Self { scheme, host, port })
2026-02-21T03:50:43.7602797Z      }
2026-02-21T03:50:43.7602929Z  }
2026-02-21T03:50:43.7603061Z -
2026-02-21T03:50:43.7603408Z  
2026-02-21T03:50:43.7603955Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/mod.rs:107:
2026-02-21T03:50:43.7604478Z              .record_job_outcome(
2026-02-21T03:50:43.7604681Z                  url,
2026-02-21T03:50:43.7604847Z                  4,
2026-02-21T03:50:43.7605010Z -                10_000_000, // 10 MiB
2026-02-21T03:50:43.7605236Z +                10_000_000,             // 10 MiB
2026-02-21T03:50:43.7605545Z                  Duration::from_secs(5), // 2 MiB/s > 1 MiB/s threshold
2026-02-21T03:50:43.7605824Z                  0,
2026-02-21T03:50:43.7605974Z                  0,
2026-02-21T03:50:43.7606404Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/mod.rs:146:
2026-02-21T03:50:43.7606904Z          assert!(n >= 2);
2026-02-21T03:50:43.7607079Z      }
2026-02-21T03:50:43.7607214Z  }
2026-02-21T03:50:43.7607343Z -
2026-02-21T03:50:43.7607497Z  
2026-02-21T03:50:43.7607956Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/persist.rs:9:
2026-02-21T03:50:43.7608581Z      /// Default path for host policy file: `~/.local/state/ddm/host_policy.json`.
2026-02-21T03:50:43.7608989Z      pub fn default_path() -> Result<std::path::PathBuf> {
2026-02-21T03:50:43.7609333Z          let xdg_dirs = xdg::BaseDirectories::with_prefix("ddm")?;
2026-02-21T03:50:43.7609713Z -        Ok(xdg_dirs.get_state_home().join("ddm").join("host_policy.json"))
2026-02-21T03:50:43.7610042Z +        Ok(xdg_dirs
2026-02-21T03:50:43.7610365Z +            .get_state_home()
2026-02-21T03:50:43.7610720Z +            .join("ddm")
2026-02-21T03:50:43.7610926Z +            .join("host_policy.json"))
2026-02-21T03:50:43.7611141Z      }
2026-02-21T03:50:43.7611274Z  
2026-02-21T03:50:43.7611525Z      /// Save current policy to the given path (creates parent dir if needed).
2026-02-21T03:50:43.7612144Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/persist.rs:16:
2026-02-21T03:50:43.7612723Z      pub fn save_to_path(&self, path: &Path) -> Result<()> {
2026-02-21T03:50:43.7613035Z          let snapshot = self.to_snapshot();
2026-02-21T03:50:43.7613412Z          if let Some(parent) = path.parent() {
2026-02-21T03:50:43.7613851Z -            std::fs::create_dir_all(parent).with_context(|| format!("create dir: {}", parent.display()))?;
2026-02-21T03:50:43.7614287Z +            std::fs::create_dir_all(parent)
2026-02-21T03:50:43.7614756Z +                .with_context(|| format!("create dir: {}", parent.display()))?;
2026-02-21T03:50:43.7615063Z          }
2026-02-21T03:50:43.7615560Z          let json = serde_json::to_string_pretty(&snapshot).context("serialize host policy")?;
2026-02-21T03:50:43.7616120Z -        std::fs::write(path, json).with_context(|| format!("write host policy: {}", path.display()))?;
2026-02-21T03:50:43.7616542Z +        std::fs::write(path, json)
2026-02-21T03:50:43.7616854Z +            .with_context(|| format!("write host policy: {}", path.display()))?;
2026-02-21T03:50:43.7617172Z          Ok(())
2026-02-21T03:50:43.7617328Z      }
2026-02-21T03:50:43.7617471Z  
2026-02-21T03:50:43.7617902Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/persist.rs:34:
2026-02-21T03:50:43.7618600Z          let bytes = match std::fs::read(path) {
2026-02-21T03:50:43.7618855Z              Ok(b) => b,
2026-02-21T03:50:43.7619147Z              Err(e) if e.kind() == std::io::ErrorKind::NotFound => return Ok(None),
2026-02-21T03:50:43.7619627Z -            Err(e) => return Err(e).with_context(|| format!("read host policy: {}", path.display())),
2026-02-21T03:50:43.7620018Z +            Err(e) => {
2026-02-21T03:50:43.7620331Z +                return Err(e).with_context(|| format!("read host policy: {}", path.display()))
2026-02-21T03:50:43.7620683Z +            }
2026-02-21T03:50:43.7620830Z          };
2026-02-21T03:50:43.7621013Z -        let snapshot: PersistedHostPolicy =
2026-02-21T03:50:43.7621579Z -            serde_json::from_slice(&bytes).with_context(|| format!("parse host policy: {}", path.display()))?;
2026-02-21T03:50:43.7622152Z -        Ok(Some(HostPolicy::from_snapshot(snapshot, min_segments, max_segments)))
2026-02-21T03:50:43.7622606Z +        let snapshot: PersistedHostPolicy = serde_json::from_slice(&bytes)
2026-02-21T03:50:43.7623028Z +            .with_context(|| format!("parse host policy: {}", path.display()))?;
2026-02-21T03:50:43.7623496Z +        Ok(Some(HostPolicy::from_snapshot(
2026-02-21T03:50:43.7623796Z +            snapshot,
2026-02-21T03:50:43.7624083Z +            min_segments,
2026-02-21T03:50:43.7624271Z +            max_segments,
2026-02-21T03:50:43.7624446Z +        )))
2026-02-21T03:50:43.7624592Z      }
2026-02-21T03:50:43.7624730Z  }
2026-02-21T03:50:43.7624866Z  
2026-02-21T03:50:43.7625328Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/state/adaptive.rs:12:
2026-02-21T03:50:43.7625865Z  
2026-02-21T03:50:43.7626110Z  /// Default adaptive segment count for a new host (start at 4 per spec).
2026-02-21T03:50:43.7626554Z  pub(super) fn default_adaptive_limit(policy: &HostPolicy) -> usize {
2026-02-21T03:50:43.7626864Z -    (4_usize)
2026-02-21T03:50:43.7627040Z -        .max(policy.min_segments)
2026-02-21T03:50:43.7627260Z -        .min(policy.max_segments)
2026-02-21T03:50:43.7627547Z +    (4_usize).max(policy.min_segments).min(policy.max_segments)
2026-02-21T03:50:43.7627841Z  }
2026-02-21T03:50:43.7627972Z  
2026-02-21T03:50:43.7628221Z  /// Compute the recommended maximum number of segments for a host key.
2026-02-21T03:50:43.7628855Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/state/adaptive.rs:22:
2026-02-21T03:50:43.7629525Z  /// Conservative heuristic: start from global max, halve for each group of three
2026-02-21T03:50:43.7629914Z  /// throttling events, never below min_segments.
2026-02-21T03:50:43.7630311Z  pub(super) fn recommended_max_segments(policy: &HostPolicy, key: &HostKey) -> usize {
2026-02-21T03:50:43.7630687Z -    let base = policy
2026-02-21T03:50:43.7630872Z -        .max_segments
2026-02-21T03:50:43.7631061Z -        .max(policy.min_segments)
2026-02-21T03:50:43.7631265Z -        .max(1);
2026-02-21T03:50:43.7631517Z +    let base = policy.max_segments.max(policy.min_segments).max(1);
2026-02-21T03:50:43.7631862Z      let Some(entry) = policy.entries.get(key) else {
2026-02-21T03:50:43.7632266Z          return base;
2026-02-21T03:50:43.7632460Z      };
2026-02-21T03:50:43.7633250Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/state/adaptive.rs:70:
2026-02-21T03:50:43.7633822Z      }
2026-02-21T03:50:43.7633967Z  
2026-02-21T03:50:43.7634139Z      if throttle_events > 0 || error_events > 0 {
2026-02-21T03:50:43.7634399Z -        entry.adaptive_segment_limit =
2026-02-21T03:50:43.7634717Z -            (entry.adaptive_segment_limit / 2).max(min_seg).min(max_seg);
2026-02-21T03:50:43.7635214Z +        entry.adaptive_segment_limit = (entry.adaptive_segment_limit / 2).max(min_seg).min(max_seg);
2026-02-21T03:50:43.7635646Z      } else if bps >= THROUGHPUT_GOOD_BPS {
2026-02-21T03:50:43.7635926Z          let next = match entry.adaptive_segment_limit {
2026-02-21T03:50:43.7636199Z              n if n < 8 => 8,
2026-02-21T03:50:43.7636685Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/host_policy/state/mod.rs:12:
2026-02-21T03:50:43.7637256Z  use super::entry::{HostEntry, RangeSupport};
2026-02-21T03:50:43.7637507Z  use super::HostKey;
2026-02-21T03:50:43.7637684Z  use adaptive::{
2026-02-21T03:50:43.7638038Z -    adaptive_segment_count, default_adaptive_limit, record_job_outcome, recommended_max_segments,
2026-02-21T03:50:43.7638629Z +    adaptive_segment_count, default_adaptive_limit, recommended_max_segments, record_job_outcome,
2026-02-21T03:50:43.7639026Z  };
2026-02-21T03:50:43.7639158Z  
2026-02-21T03:50:43.7639334Z  pub use snapshot::PersistedHostPolicy;
2026-02-21T03:50:43.7639954Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/lib.rs:3:
2026-02-21T03:50:43.7640448Z  
2026-02-21T03:50:43.7640780Z  // Core modules (to be implemented step by step)
2026-02-21T03:50:43.7641235Z  pub mod bench;
2026-02-21T03:50:43.7641412Z -pub mod har;
2026-02-21T03:50:43.7641580Z -pub mod url_model;
2026-02-21T03:50:43.7641792Z +pub mod checksum;
2026-02-21T03:50:43.7641960Z +pub mod control;
2026-02-21T03:50:43.7642123Z +pub mod downloader;
2026-02-21T03:50:43.7642303Z  pub mod fetch_head;
2026-02-21T03:50:43.7642471Z -pub mod segmenter;
2026-02-21T03:50:43.7642638Z +pub mod har;
2026-02-21T03:50:43.7642795Z +pub mod host_policy;
2026-02-21T03:50:43.7642974Z +pub mod resolver;
2026-02-21T03:50:43.7643324Z +pub mod resume_db;
2026-02-21T03:50:43.7643498Z +pub mod retry;
2026-02-21T03:50:43.7643661Z  pub mod safe_resume;
2026-02-21T03:50:43.7643838Z  pub mod scheduler;
2026-02-21T03:50:43.7644002Z -pub mod retry;
2026-02-21T03:50:43.7644162Z -pub mod downloader;
2026-02-21T03:50:43.7644342Z +pub mod segmenter;
2026-02-21T03:50:43.7644503Z  pub mod storage;
2026-02-21T03:50:43.7644664Z -pub mod resume_db;
2026-02-21T03:50:43.7644830Z -pub mod checksum;
2026-02-21T03:50:43.7644992Z -pub mod resolver;
2026-02-21T03:50:43.7645155Z -pub mod host_policy;
2026-02-21T03:50:43.7645332Z -pub mod control;
2026-02-21T03:50:43.7645488Z -
2026-02-21T03:50:43.7645632Z +pub mod url_model;
2026-02-21T03:50:43.7645786Z  
2026-02-21T03:50:43.7646186Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/logging.rs:83:
2026-02-21T03:50:43.7646664Z          .with_ansi(false)
2026-02-21T03:50:43.7646848Z          .init();
2026-02-21T03:50:43.7647000Z  }
2026-02-21T03:50:43.7647132Z -
2026-02-21T03:50:43.7647266Z  
2026-02-21T03:50:43.7647575Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resolver.rs:47:
2026-02-21T03:50:43.7647666Z          assert!(spec.headers.is_empty());
2026-02-21T03:50:43.7647730Z      }
2026-02-21T03:50:43.7647788Z  }
2026-02-21T03:50:43.7647851Z -
2026-02-21T03:50:43.7647910Z  
2026-02-21T03:50:43.7648247Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/db.rs:123:
2026-02-21T03:50:43.7648325Z      db.migrate().await?;
2026-02-21T03:50:43.7648389Z      Ok(db)
2026-02-21T03:50:43.7648598Z  }
2026-02-21T03:50:43.7648657Z -
2026-02-21T03:50:43.7648716Z  
2026-02-21T03:50:43.7649079Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/jobs/read.rs:4:
2026-02-21T03:50:43.7649160Z  use sqlx::Row;
2026-02-21T03:50:43.7649218Z  
2026-02-21T03:50:43.7649305Z  use super::super::db::ResumeDb;
2026-02-21T03:50:43.7649517Z -use super::super::types::{JobDetails, JobId, JobState, JobSettings, JobSummary};
2026-02-21T03:50:43.7649707Z +use super::super::types::{JobDetails, JobId, JobSettings, JobState, JobSummary};
2026-02-21T03:50:43.7649766Z  
2026-02-21T03:50:43.7649832Z  impl ResumeDb {
2026-02-21T03:50:43.7649953Z      /// List all jobs in the database, newest first.
2026-02-21T03:50:43.7650313Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/jobs/read.rs:47:
2026-02-21T03:50:43.7650395Z          download_dir: Option<&str>,
2026-02-21T03:50:43.7650484Z          exclude_job_id: Option<JobId>,
2026-02-21T03:50:43.7650568Z      ) -> Result<Vec<String>> {
2026-02-21T03:50:43.7650645Z -        let rows = sqlx::query(
2026-02-21T03:50:43.7650797Z -            r#"SELECT id, final_filename, settings_json FROM jobs"#,
2026-02-21T03:50:43.7650858Z -        )
2026-02-21T03:50:43.7650934Z -        .fetch_all(&self.pool)
2026-02-21T03:50:43.7650998Z -        .await?;
2026-02-21T03:50:43.7651202Z +        let rows = sqlx::query(r#"SELECT id, final_filename, settings_json FROM jobs"#)
2026-02-21T03:50:43.7651281Z +            .fetch_all(&self.pool)
2026-02-21T03:50:43.7651346Z +            .await?;
2026-02-21T03:50:43.7651409Z  
2026-02-21T03:50:43.7651490Z          let mut out = Vec::new();
2026-02-21T03:50:43.7651708Z          for row in rows {
2026-02-21T03:50:43.7652074Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/mod.rs:12:
2026-02-21T03:50:43.7652140Z  
2026-02-21T03:50:43.7652215Z  pub use db::ResumeDb;
2026-02-21T03:50:43.7652289Z  pub use types::*;
2026-02-21T03:50:43.7652357Z -
2026-02-21T03:50:43.7652416Z  
2026-02-21T03:50:43.7654577Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/tests.rs:1:
2026-02-21T03:50:43.7654735Z  //! Tests for resume_db (use in-memory DB helper from db).
2026-02-21T03:50:43.7654801Z  
2026-02-21T03:50:43.7654903Z  use crate::resume_db::db::open_memory;
2026-02-21T03:50:43.7655087Z -use crate::resume_db::{JobMetadata, ResumeDb, JobState, JobSettings};
2026-02-21T03:50:43.7655257Z +use crate::resume_db::{JobMetadata, JobSettings, JobState, ResumeDb};
2026-02-21T03:50:43.7655317Z  
2026-02-21T03:50:43.7655388Z  #[tokio::test]
2026-02-21T03:50:43.7655495Z  async fn job_state_roundtrip_via_db() {
2026-02-21T03:50:43.7655850Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/tests.rs:103:
2026-02-21T03:50:43.7655930Z  
2026-02-21T03:50:43.7656076Z      let claimed = db.claim_next_queued_job().await.unwrap();
2026-02-21T03:50:43.7656164Z      assert_eq!(claimed, Some(id1));
2026-02-21T03:50:43.7656442Z -    assert_eq!(db.list_jobs().await.unwrap().iter().find(|j| j.id == id1).unwrap().state, JobState::Running);
2026-02-21T03:50:43.7656514Z +    assert_eq!(
2026-02-21T03:50:43.7656586Z +        db.list_jobs()
2026-02-21T03:50:43.7656650Z +            .await
2026-02-21T03:50:43.7656717Z +            .unwrap()
2026-02-21T03:50:43.7656784Z +            .iter()
2026-02-21T03:50:43.7656861Z +            .find(|j| j.id == id1)
2026-02-21T03:50:43.7656926Z +            .unwrap()
2026-02-21T03:50:43.7656992Z +            .state,
2026-02-21T03:50:43.7657066Z +        JobState::Running
2026-02-21T03:50:43.7657184Z +    );
2026-02-21T03:50:43.7657294Z  
2026-02-21T03:50:43.7657544Z      let claimed2 = db.claim_next_queued_job().await.unwrap();
2026-02-21T03:50:43.7657667Z      assert_eq!(claimed2, Some(id2));
2026-02-21T03:50:43.7658019Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/tests.rs:110:
2026-02-21T03:50:43.7658460Z -    assert_eq!(db.list_jobs().await.unwrap().iter().find(|j| j.id == id2).unwrap().state, JobState::Running);
2026-02-21T03:50:43.7658529Z +    assert_eq!(
2026-02-21T03:50:43.7658597Z +        db.list_jobs()
2026-02-21T03:50:43.7658658Z +            .await
2026-02-21T03:50:43.7658729Z +            .unwrap()
2026-02-21T03:50:43.7658791Z +            .iter()
2026-02-21T03:50:43.7658866Z +            .find(|j| j.id == id2)
2026-02-21T03:50:43.7658935Z +            .unwrap()
2026-02-21T03:50:43.7658996Z +            .state,
2026-02-21T03:50:43.7659070Z +        JobState::Running
2026-02-21T03:50:43.7659136Z +    );
2026-02-21T03:50:43.7659199Z  
2026-02-21T03:50:43.7659339Z      let claimed3 = db.claim_next_queued_job().await.unwrap();
2026-02-21T03:50:43.7659418Z      assert_eq!(claimed3, None);
2026-02-21T03:50:43.7659778Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/resume_db/types.rs:92:
2026-02-21T03:50:43.7659863Z      pub segment_count: i64,
2026-02-21T03:50:43.7659943Z      pub completed_bitmap: Vec<u8>,
2026-02-21T03:50:43.7660009Z  }
2026-02-21T03:50:43.7660069Z -
2026-02-21T03:50:43.7660128Z  
2026-02-21T03:50:43.7664583Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/retry/error.rs:26:
2026-02-21T03:50:43.7664779Z              SegmentError::Curl(e) => write!(f, "{}", e),
2026-02-21T03:50:43.7664988Z              SegmentError::Http(code) => write!(f, "HTTP {}", code),
2026-02-21T03:50:43.7665116Z              SegmentError::InvalidRangeResponse(code) => {
2026-02-21T03:50:43.7665462Z -                write!(f, "range request got HTTP {} instead of 206 Partial Content", code)
2026-02-21T03:50:43.7665540Z +                write!(
2026-02-21T03:50:43.7665608Z +                    f,
2026-02-21T03:50:43.7665796Z +                    "range request got HTTP {} instead of 206 Partial Content",
2026-02-21T03:50:43.7665865Z +                    code
2026-02-21T03:50:43.7665933Z +                )
2026-02-21T03:50:43.7666000Z              }
2026-02-21T03:50:43.7666166Z              SegmentError::PartialTransfer { expected, received } => {
2026-02-21T03:50:43.7666371Z -                write!(f, "partial transfer: expected {} bytes, got {}", expected, received)
2026-02-21T03:50:43.7666439Z +                write!(
2026-02-21T03:50:43.7666509Z +                    f,
2026-02-21T03:50:43.7666633Z +                    "partial transfer: expected {} bytes, got {}",
2026-02-21T03:50:43.7666712Z +                    expected, received
2026-02-21T03:50:43.7666784Z +                )
2026-02-21T03:50:43.7666845Z              }
2026-02-21T03:50:43.7666997Z              SegmentError::Storage(e) => write!(f, "storage: {}", e),
2026-02-21T03:50:43.7667059Z          }
2026-02-21T03:50:43.7667392Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/retry/mod.rs:13:
2026-02-21T03:50:43.7667480Z  pub use error::SegmentError;
2026-02-21T03:50:43.7667620Z  pub use policy::{ErrorKind, RetryDecision, RetryPolicy};
2026-02-21T03:50:43.7667708Z  pub use run::run_with_retry;
2026-02-21T03:50:43.7667767Z -
2026-02-21T03:50:43.7667824Z  
2026-02-21T03:50:43.7671317Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/retry/policy.rs:122:
2026-02-21T03:50:43.7671451Z              p.decide(2, ErrorKind::Throttled),
2026-02-21T03:50:43.7671545Z              RetryDecision::RetryAfter(_)
2026-02-21T03:50:43.7671610Z          ));
2026-02-21T03:50:43.7671679Z -        assert_eq!(
2026-02-21T03:50:43.7671776Z -            p.decide(3, ErrorKind::Throttled),
2026-02-21T03:50:43.7671875Z -            RetryDecision::NoRetry
2026-02-21T03:50:43.7671942Z -        );
2026-02-21T03:50:43.7672130Z +        assert_eq!(p.decide(3, ErrorKind::Throttled), RetryDecision::NoRetry);
2026-02-21T03:50:43.7672194Z      }
2026-02-21T03:50:43.7672258Z  }
2026-02-21T03:50:43.7672319Z -
2026-02-21T03:50:43.7672376Z  
2026-02-21T03:50:43.7684521Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:49:
2026-02-21T03:50:43.7684879Z                          write!(f, ", size")?;
2026-02-21T03:50:43.7684967Z                      }
2026-02-21T03:50:43.7685033Z                  }
2026-02-21T03:50:43.7685242Z -                write!(f, "; use --force-restart to discard progress and re-download")?;
2026-02-21T03:50:43.7685310Z +                write!(
2026-02-21T03:50:43.7685375Z +                    f,
2026-02-21T03:50:43.7685576Z +                    "; use --force-restart to discard progress and re-download"
2026-02-21T03:50:43.7685638Z +                )?;
2026-02-21T03:50:43.7685707Z                  Ok(())
2026-02-21T03:50:43.7685775Z              }
2026-02-21T03:50:43.7685834Z          }
2026-02-21T03:50:43.7686205Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:64:
2026-02-21T03:50:43.7686413Z  /// can proceed with initial probe and segment planning. Otherwise compares ETag,
2026-02-21T03:50:43.7686598Z  /// Last-Modified, and size; returns Err(ValidationError) if any differ.
2026-02-21T03:50:43.7686851Z  pub fn validate_for_resume(job: &JobDetails, head: &HeadResult) -> Result<(), ValidationError> {
2026-02-21T03:50:43.7686956Z -    let has_stored = job.total_size.is_some()
2026-02-21T03:50:43.7687031Z -        || job.etag.is_some()
2026-02-21T03:50:43.7687113Z -        || job.last_modified.is_some();
2026-02-21T03:50:43.7687354Z +    let has_stored = job.total_size.is_some() || job.etag.is_some() || job.last_modified.is_some();
2026-02-21T03:50:43.7687418Z  
2026-02-21T03:50:43.7687487Z      if !has_stored {
2026-02-21T03:50:43.7687672Z          return Ok(());
2026-02-21T03:50:43.7688060Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:107:
2026-02-21T03:50:43.7688128Z  #[cfg(test)]
2026-02-21T03:50:43.7688193Z  mod tests {
2026-02-21T03:50:43.7688271Z      use super::*;
2026-02-21T03:50:43.7688394Z -    use crate::resume_db::{JobState, JobSettings};
2026-02-21T03:50:43.7688502Z +    use crate::resume_db::{JobSettings, JobState};
2026-02-21T03:50:43.7688561Z  
2026-02-21T03:50:43.7688632Z      fn job_details(
2026-02-21T03:50:43.7688714Z          total_size: Option<i64>,
2026-02-21T03:50:43.7689073Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:148:
2026-02-21T03:50:43.7689139Z      #[test]
2026-02-21T03:50:43.7689223Z      fn no_stored_metadata_ok() {
2026-02-21T03:50:43.7689320Z          let job = job_details(None, None, None);
2026-02-21T03:50:43.7689530Z -        let head = head_result(Some(1000), Some("e1"), Some("Wed, 21 Oct 2015 07:28:00 GMT"));
2026-02-21T03:50:43.7689614Z +        let head = head_result(
2026-02-21T03:50:43.7689683Z +            Some(1000),
2026-02-21T03:50:43.7689751Z +            Some("e1"),
2026-02-21T03:50:43.7689843Z +            Some("Wed, 21 Oct 2015 07:28:00 GMT"),
2026-02-21T03:50:43.7689909Z +        );
2026-02-21T03:50:43.7690032Z          assert!(validate_for_resume(&job, &head).is_ok());
2026-02-21T03:50:43.7690094Z      }
2026-02-21T03:50:43.7690157Z  
2026-02-21T03:50:43.7690514Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:155:
2026-02-21T03:50:43.7690578Z      #[test]
2026-02-21T03:50:43.7690656Z      fn same_etag_and_size_ok() {
2026-02-21T03:50:43.7690848Z -        let job = job_details(Some(1000), Some("e1"), Some("Wed, 21 Oct 2015 07:28:00 GMT"));
2026-02-21T03:50:43.7691046Z -        let head = head_result(Some(1000), Some("e1"), Some("Wed, 21 Oct 2015 07:28:00 GMT"));
2026-02-21T03:50:43.7691124Z +        let job = job_details(
2026-02-21T03:50:43.7691198Z +            Some(1000),
2026-02-21T03:50:43.7691264Z +            Some("e1"),
2026-02-21T03:50:43.7691349Z +            Some("Wed, 21 Oct 2015 07:28:00 GMT"),
2026-02-21T03:50:43.7691417Z +        );
2026-02-21T03:50:43.7691575Z +        let head = head_result(
2026-02-21T03:50:43.7691641Z +            Some(1000),
2026-02-21T03:50:43.7691708Z +            Some("e1"),
2026-02-21T03:50:43.7691800Z +            Some("Wed, 21 Oct 2015 07:28:00 GMT"),
2026-02-21T03:50:43.7691863Z +        );
2026-02-21T03:50:43.7691979Z          assert!(validate_for_resume(&job, &head).is_ok());
2026-02-21T03:50:43.7692046Z      }
2026-02-21T03:50:43.7692151Z  
2026-02-21T03:50:43.7692803Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:162:
2026-02-21T03:50:43.7692883Z      #[test]
2026-02-21T03:50:43.7692964Z      fn etag_changed_err() {
2026-02-21T03:50:43.7693398Z -        let job = job_details(Some(1000), Some("e1"), Some("Wed, 21 Oct 2015 07:28:00 GMT"));
2026-02-21T03:50:43.7693692Z -        let head = head_result(Some(1000), Some("e2"), Some("Wed, 21 Oct 2015 07:28:00 GMT"));
2026-02-21T03:50:43.7693781Z +        let job = job_details(
2026-02-21T03:50:43.7693849Z +            Some(1000),
2026-02-21T03:50:43.7693921Z +            Some("e1"),
2026-02-21T03:50:43.7694012Z +            Some("Wed, 21 Oct 2015 07:28:00 GMT"),
2026-02-21T03:50:43.7694074Z +        );
2026-02-21T03:50:43.7694147Z +        let head = head_result(
2026-02-21T03:50:43.7694217Z +            Some(1000),
2026-02-21T03:50:43.7694291Z +            Some("e2"),
2026-02-21T03:50:43.7694376Z +            Some("Wed, 21 Oct 2015 07:28:00 GMT"),
2026-02-21T03:50:43.7694436Z +        );
2026-02-21T03:50:43.7694537Z          let r = validate_for_resume(&job, &head);
2026-02-21T03:50:43.7694611Z          assert!(r.is_err());
2026-02-21T03:50:43.7694687Z          let e = r.unwrap_err();
2026-02-21T03:50:43.7695189Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:169:
2026-02-21T03:50:43.7695464Z -        assert!(matches!(e.kind, ValidationErrorKind::RemoteChanged { etag_changed: true, .. }));
2026-02-21T03:50:43.7695541Z +        assert!(matches!(
2026-02-21T03:50:43.7695608Z +            e.kind,
2026-02-21T03:50:43.7695718Z +            ValidationErrorKind::RemoteChanged {
2026-02-21T03:50:43.7695795Z +                etag_changed: true,
2026-02-21T03:50:43.7695857Z +                ..
2026-02-21T03:50:43.7695920Z +            }
2026-02-21T03:50:43.7695979Z +        ));
2026-02-21T03:50:43.7696037Z      }
2026-02-21T03:50:43.7696095Z  
2026-02-21T03:50:43.7696160Z      #[test]
2026-02-21T03:50:43.7696517Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:176:
2026-02-21T03:50:43.7696613Z          let r = validate_for_resume(&job, &head);
2026-02-21T03:50:43.7696694Z          assert!(r.is_err());
2026-02-21T03:50:43.7696769Z          let e = r.unwrap_err();
2026-02-21T03:50:43.7697011Z -        assert!(matches!(e.kind, ValidationErrorKind::RemoteChanged { size_changed: true, .. }));
2026-02-21T03:50:43.7697120Z +        assert!(matches!(
2026-02-21T03:50:43.7697242Z +            e.kind,
2026-02-21T03:50:43.7697436Z +            ValidationErrorKind::RemoteChanged {
2026-02-21T03:50:43.7697525Z +                size_changed: true,
2026-02-21T03:50:43.7697592Z +                ..
2026-02-21T03:50:43.7697653Z +            }
2026-02-21T03:50:43.7697713Z +        ));
2026-02-21T03:50:43.7697772Z      }
2026-02-21T03:50:43.7697836Z  
2026-02-21T03:50:43.7697898Z      #[test]
2026-02-21T03:50:43.7698258Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/safe_resume/validate.rs:186:
2026-02-21T03:50:43.7698356Z          let r = validate_for_resume(&job, &head);
2026-02-21T03:50:43.7698427Z          assert!(r.is_err());
2026-02-21T03:50:43.7698507Z          let e = r.unwrap_err();
2026-02-21T03:50:43.7698788Z -        assert!(matches!(e.kind, ValidationErrorKind::RemoteChanged { last_modified_changed: true, .. }));
2026-02-21T03:50:43.7698864Z +        assert!(matches!(
2026-02-21T03:50:43.7698929Z +            e.kind,
2026-02-21T03:50:43.7699025Z +            ValidationErrorKind::RemoteChanged {
2026-02-21T03:50:43.7699251Z +                last_modified_changed: true,
2026-02-21T03:50:43.7699313Z +                ..
2026-02-21T03:50:43.7699372Z +            }
2026-02-21T03:50:43.7699431Z +        ));
2026-02-21T03:50:43.7699494Z      }
2026-02-21T03:50:43.7699553Z  }
2026-02-21T03:50:43.7699611Z  
2026-02-21T03:50:43.7699985Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/choose.rs:13:
2026-02-21T03:50:43.7700067Z      let adaptive = host_policy
2026-02-21T03:50:43.7700158Z          .adaptive_segment_count_for_url(url)
2026-02-21T03:50:43.7700337Z          .unwrap_or_else(|_| cfg.min_segments.max(1).min(cfg.max_segments));
2026-02-21T03:50:43.7700408Z -    let n = adaptive
2026-02-21T03:50:43.7700480Z -        .max(cfg.min_segments)
2026-02-21T03:50:43.7700552Z -        .min(cfg.max_segments)
2026-02-21T03:50:43.7700620Z -        .max(1);
2026-02-21T03:50:43.7700789Z +    let n = adaptive.max(cfg.min_segments).min(cfg.max_segments).max(1);
2026-02-21T03:50:43.7700867Z      if total_size == 0 {
2026-02-21T03:50:43.7700935Z          return n;
2026-02-21T03:50:43.7700993Z      }
2026-02-21T03:50:43.7701358Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/finish.rs:5:
2026-02-21T03:50:43.7701443Z  use std::time::Duration;
2026-02-21T03:50:43.7701503Z  
2026-02-21T03:50:43.7701597Z  use crate::downloader::DownloadSummary;
2026-02-21T03:50:43.7701683Z +use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7701820Z  use crate::resume_db::{JobMetadata, JobState, ResumeDb};
2026-02-21T03:50:43.7701892Z  use crate::segmenter;
2026-02-21T03:50:43.7702046Z  use crate::storage;
2026-02-21T03:50:43.7702427Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/finish.rs:11:
2026-02-21T03:50:43.7702513Z -use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7702570Z  
2026-02-21T03:50:43.7702786Z  /// After download completes (or is aborted with pause): record host policy outcome,
2026-02-21T03:50:43.7703009Z  /// sync storage, update DB metadata, and finalize file + set state if all segments done.
2026-02-21T03:50:43.7721363Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/mod.rs:15:
2026-02-21T03:50:43.7721548Z  use crate::config::{DdmConfig, DownloadBackend};
2026-02-21T03:50:43.7721641Z  use crate::control::JobAborted;
2026-02-21T03:50:43.7721738Z  use crate::downloader::DownloadSummary;
2026-02-21T03:50:43.7721873Z +use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7721981Z  use crate::resume_db::{JobState, ResumeDb};
2026-02-21T03:50:43.7722063Z  use crate::retry::RetryPolicy;
2026-02-21T03:50:43.7722142Z  use crate::segmenter;
2026-02-21T03:50:43.7722517Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/mod.rs:21:
2026-02-21T03:50:43.7722588Z  use crate::storage;
2026-02-21T03:50:43.7722678Z -use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7722742Z  
2026-02-21T03:50:43.7722823Z  use self::guard::BudgetGuard;
2026-02-21T03:50:43.7722968Z  use self::progress_worker::run_progress_persistence_loop;
2026-02-21T03:50:43.7723535Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/mod.rs:53:
2026-02-21T03:50:43.7723699Z      abort: Option<std::sync::Arc<std::sync::atomic::AtomicBool>>,
2026-02-21T03:50:43.7723775Z  ) -> Result<()> {
2026-02-21T03:50:43.7723883Z      if needs_metadata && temp_path.exists() {
2026-02-21T03:50:43.7723975Z -        tokio::fs::remove_file(temp_path)
2026-02-21T03:50:43.7724043Z -            .await
2026-02-21T03:50:43.7724296Z -            .with_context(|| format!("remove temp file for force-restart: {}", temp_path.display()))?;
2026-02-21T03:50:43.7724447Z +        tokio::fs::remove_file(temp_path).await.with_context(|| {
2026-02-21T03:50:43.7724515Z +            format!(
2026-02-21T03:50:43.7724783Z +                "remove temp file for force-restart: {}",
2026-02-21T03:50:43.7724869Z +                temp_path.display()
2026-02-21T03:50:43.7724932Z +            )
2026-02-21T03:50:43.7724993Z +        })?;
2026-02-21T03:50:43.7725241Z          tracing::debug!(path = %temp_path.display(), "removed existing .part for clean restart");
2026-02-21T03:50:43.7725302Z      }
2026-02-21T03:50:43.7725362Z  
2026-02-21T03:50:43.7725726Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/mod.rs:80:
2026-02-21T03:50:43.7725797Z          budget: b,
2026-02-21T03:50:43.7725881Z          reserved: actual_concurrent,
2026-02-21T03:50:43.7725946Z      });
2026-02-21T03:50:43.7726097Z -    let retry_policy = cfg.retry.as_ref().map(|r| RetryPolicy {
2026-02-21T03:50:43.7726184Z -        max_attempts: r.max_attempts,
2026-02-21T03:50:43.7726313Z -        base_delay: Duration::from_secs_f64(r.base_delay_secs),
2026-02-21T03:50:43.7726436Z -        max_delay: Duration::from_secs(r.max_delay_secs),
2026-02-21T03:50:43.7726546Z -    }).unwrap_or_else(RetryPolicy::default);
2026-02-21T03:50:43.7726623Z +    let retry_policy = cfg
2026-02-21T03:50:43.7726685Z +        .retry
2026-02-21T03:50:43.7726752Z +        .as_ref()
2026-02-21T03:50:43.7726826Z +        .map(|r| RetryPolicy {
2026-02-21T03:50:43.7726911Z +            max_attempts: r.max_attempts,
2026-02-21T03:50:43.7727051Z +            base_delay: Duration::from_secs_f64(r.base_delay_secs),
2026-02-21T03:50:43.7727174Z +            max_delay: Duration::from_secs(r.max_delay_secs),
2026-02-21T03:50:43.7727236Z +        })
2026-02-21T03:50:43.7727442Z +        .unwrap_or_else(RetryPolicy::default);
2026-02-21T03:50:43.7727510Z  
2026-02-21T03:50:43.7727718Z      let curl_opts = crate::downloader::CurlOptions::per_handle(
2026-02-21T03:50:43.7727856Z          cfg.max_bytes_per_sec,
2026-02-21T03:50:43.7728469Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/mod.rs:100:
2026-02-21T03:50:43.7728580Z      let download_start = Instant::now();
2026-02-21T03:50:43.7728642Z  
2026-02-21T03:50:43.7728824Z      let in_flight_bytes: Arc<Vec<std::sync::atomic::AtomicU64>> = Arc::new(
2026-02-21T03:50:43.7729017Z -        (0..segment_count_u).map(|_| std::sync::atomic::AtomicU64::new(0)).collect(),
2026-02-21T03:50:43.7729093Z +        (0..segment_count_u)
2026-02-21T03:50:43.7729208Z +            .map(|_| std::sync::atomic::AtomicU64::new(0))
2026-02-21T03:50:43.7729283Z +            .collect(),
2026-02-21T03:50:43.7729345Z      );
2026-02-21T03:50:43.7729528Z      let (bitmap_tx, progress_rx) = tokio::sync::mpsc::channel::<Vec<u8>>(8);
2026-02-21T03:50:43.7729759Z      let progress_handle = tokio::spawn(run_progress_persistence_loop(
2026-02-21T03:50:43.7730251Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/mod.rs:128:
2026-02-21T03:50:43.7730369Z          let in_flight = Arc::clone(&in_flight_bytes);
2026-02-21T03:50:43.7730467Z          let abort_clone = abort.clone();
2026-02-21T03:50:43.7730545Z          let curl = curl_opts;
2026-02-21T03:50:43.7730805Z -        tokio::task::spawn_blocking(move || -> Result<(segmenter::SegmentBitmap, DownloadSummary)> {
2026-02-21T03:50:43.7730923Z -            let mut summary = DownloadSummary::default();
2026-02-21T03:50:43.7731007Z -            run_download_blocking(
2026-02-21T03:50:43.7731075Z -                &url,
2026-02-21T03:50:43.7731142Z -                &headers,
2026-02-21T03:50:43.7731215Z -                &segments,
2026-02-21T03:50:43.7731280Z -                &storage,
2026-02-21T03:50:43.7731360Z -                &mut bitmap_copy,
2026-02-21T03:50:43.7731434Z -                max_concurrent,
2026-02-21T03:50:43.7731508Z -                &policy,
2026-02-21T03:50:43.7731577Z -                &mut summary,
2026-02-21T03:50:43.7731644Z -                Some(&tx),
2026-02-21T03:50:43.7731723Z -                Some(in_flight),
2026-02-21T03:50:43.7731899Z -                abort_clone,
2026-02-21T03:50:43.7731968Z -                use_multi,
2026-02-21T03:50:43.7732035Z -                curl,
2026-02-21T03:50:43.7732104Z -            )?;
2026-02-21T03:50:43.7732191Z -            Ok((bitmap_copy, summary))
2026-02-21T03:50:43.7732255Z -        })
2026-02-21T03:50:43.7732346Z +        tokio::task::spawn_blocking(
2026-02-21T03:50:43.7732512Z +            move || -> Result<(segmenter::SegmentBitmap, DownloadSummary)> {
2026-02-21T03:50:43.7732633Z +                let mut summary = DownloadSummary::default();
2026-02-21T03:50:43.7732718Z +                run_download_blocking(
2026-02-21T03:50:43.7732790Z +                    &url,
2026-02-21T03:50:43.7732857Z +                    &headers,
2026-02-21T03:50:43.7732925Z +                    &segments,
2026-02-21T03:50:43.7732994Z +                    &storage,
2026-02-21T03:50:43.7733073Z +                    &mut bitmap_copy,
2026-02-21T03:50:43.7733363Z +                    max_concurrent,
2026-02-21T03:50:43.7733459Z +                    &policy,
2026-02-21T03:50:43.7733531Z +                    &mut summary,
2026-02-21T03:50:43.7733599Z +                    Some(&tx),
2026-02-21T03:50:43.7733683Z +                    Some(in_flight),
2026-02-21T03:50:43.7733761Z +                    abort_clone,
2026-02-21T03:50:43.7733830Z +                    use_multi,
2026-02-21T03:50:43.7733897Z +                    curl,
2026-02-21T03:50:43.7733966Z +                )?;
2026-02-21T03:50:43.7734055Z +                Ok((bitmap_copy, summary))
2026-02-21T03:50:43.7734119Z +            },
2026-02-21T03:50:43.7734182Z +        )
2026-02-21T03:50:43.7734254Z          .await
2026-02-21T03:50:43.7734461Z          .context("download task join")?
2026-02-21T03:50:43.7734530Z      };
2026-02-21T03:50:43.7734995Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/progress_worker.rs:41:
2026-02-21T03:50:43.7735114Z                  .map(|(_, a)| a.load(Ordering::Relaxed))
2026-02-21T03:50:43.7735185Z                  .sum();
2026-02-21T03:50:43.7735345Z              let elapsed_secs = download_start.elapsed().as_secs_f64();
2026-02-21T03:50:43.7735578Z -            let segments_done = (0..segment_count_u).filter(|i| bitmap.is_completed(*i)).count();
2026-02-21T03:50:43.7735678Z +            let segments_done = (0..segment_count_u)
2026-02-21T03:50:43.7735776Z +                .filter(|i| bitmap.is_completed(*i))
2026-02-21T03:50:43.7735848Z +                .count();
2026-02-21T03:50:43.7735933Z              let stats = ProgressStats {
2026-02-21T03:50:43.7736004Z                  bytes_done,
2026-02-21T03:50:43.7736086Z                  bytes_in_flight,
2026-02-21T03:50:43.7736797Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/run_download.rs:2:
2026-02-21T03:50:43.7736872Z  
2026-02-21T03:50:43.7736958Z  use std::sync::Arc;
2026-02-21T03:50:43.7737018Z  
2026-02-21T03:50:43.7737150Z -use crate::downloader::DownloadSummary;
2026-02-21T03:50:43.7737301Z  use crate::downloader;
2026-02-21T03:50:43.7737423Z  use crate::downloader::CurlOptions;
2026-02-21T03:50:43.7737515Z +use crate::downloader::DownloadSummary;
2026-02-21T03:50:43.7737597Z  use crate::retry::RetryPolicy;
2026-02-21T03:50:43.7737674Z  use crate::segmenter;
2026-02-21T03:50:43.7737746Z  use crate::storage;
2026-02-21T03:50:43.7738142Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/single.rs:38:
2026-02-21T03:50:43.7738229Z          let url = url.to_string();
2026-02-21T03:50:43.7738310Z          let headers = headers.clone();
2026-02-21T03:50:43.7738409Z          let storage = storage_writer.clone();
2026-02-21T03:50:43.7738686Z -        move || -> Result<u64> { downloader::download_single(&url, &headers, &storage, expected_len, curl) }
2026-02-21T03:50:43.7738764Z +        move || -> Result<u64> {
2026-02-21T03:50:43.7738964Z +            downloader::download_single(&url, &headers, &storage, expected_len, curl)
2026-02-21T03:50:43.7739157Z +        }
2026-02-21T03:50:43.7739224Z      })
2026-02-21T03:50:43.7739287Z      .await
2026-02-21T03:50:43.7739376Z      .context("download task join")??;
2026-02-21T03:50:43.7739759Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/single.rs:46:
2026-02-21T03:50:43.7739837Z      storage_writer.sync()?;
2026-02-21T03:50:43.7739930Z      storage_writer.finalize(final_path)?;
2026-02-21T03:50:43.7740053Z      db.set_state(job_id, JobState::Completed).await?;
2026-02-21T03:50:43.7740259Z -    tracing::info!("job {} completed (single): {}", job_id, final_path.display());
2026-02-21T03:50:43.7740330Z +    tracing::info!(
2026-02-21T03:50:43.7740414Z +        "job {} completed (single): {}",
2026-02-21T03:50:43.7740486Z +        job_id,
2026-02-21T03:50:43.7740565Z +        final_path.display()
2026-02-21T03:50:43.7740625Z +    );
2026-02-21T03:50:43.7740693Z  
2026-02-21T03:50:43.7740770Z      Ok(bytes_written)
2026-02-21T03:50:43.7740829Z  }
2026-02-21T03:50:43.7741198Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/execute/single.rs:53:
2026-02-21T03:50:43.7741265Z -
2026-02-21T03:50:43.7741324Z  
2026-02-21T03:50:43.7741653Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/mod.rs:14:
2026-02-21T03:50:43.7741759Z  pub use budget::GlobalConnectionBudget;
2026-02-21T03:50:43.7741850Z  pub use parallel::run_jobs_parallel;
2026-02-21T03:50:43.7741940Z  pub use progress::ProgressStats;
2026-02-21T03:50:43.7742034Z -pub use run::{run_one_job, run_next_job};
2026-02-21T03:50:43.7742206Z +pub use run::{run_next_job, run_one_job};
2026-02-21T03:50:43.7742269Z  
2026-02-21T03:50:43.7750395Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/common.rs:18:
2026-02-21T03:50:43.7750492Z      validation_failed: bool,
2026-02-21T03:50:43.7750578Z      download_dir: &Path,
2026-02-21T03:50:43.7750667Z  ) -> Result<(String, String, bool)> {
2026-02-21T03:50:43.7750750Z -    let candidate_name =
2026-02-21T03:50:43.7750966Z -        url_model::derive_filename(&job.url, head.content_disposition.as_deref());
2026-02-21T03:50:43.7751226Z +    let candidate_name = url_model::derive_filename(&job.url, head.content_disposition.as_deref());
2026-02-21T03:50:43.7751307Z      let effective_dir_str = job
2026-02-21T03:50:43.7751380Z          .settings
2026-02-21T03:50:43.7751447Z          .download_dir
2026-02-21T03:50:43.7751825Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/common.rs:56:
2026-02-21T03:50:43.7751899Z          .as_deref()
2026-02-21T03:50:43.7751985Z          .map(std::path::Path::new)
2026-02-21T03:50:43.7752064Z          .unwrap_or(download_dir);
2026-02-21T03:50:43.7752158Z -    let temp_path = effective_dir.join(
2026-02-21T03:50:43.7752235Z -        job.temp_filename
2026-02-21T03:50:43.7752307Z -            .as_deref()
2026-02-21T03:50:43.7752399Z -            .unwrap_or(temp_name_str),
2026-02-21T03:50:43.7752463Z -    );
2026-02-21T03:50:43.7752553Z -    let final_path = effective_dir.join(
2026-02-21T03:50:43.7752628Z -        job.final_filename
2026-02-21T03:50:43.7752702Z -            .as_deref()
2026-02-21T03:50:43.7752781Z -            .unwrap_or(final_name),
2026-02-21T03:50:43.7752843Z -    );
2026-02-21T03:50:43.7753258Z +    let temp_path = effective_dir.join(job.temp_filename.as_deref().unwrap_or(temp_name_str));
2026-02-21T03:50:43.7753542Z +    let final_path = effective_dir.join(job.final_filename.as_deref().unwrap_or(final_name));
2026-02-21T03:50:43.7753640Z      if final_path.exists() && !overwrite {
2026-02-21T03:50:43.7753716Z          anyhow::bail!(
2026-02-21T03:50:43.7753880Z              "final file already exists: {} (use --overwrite to replace)",
2026-02-21T03:50:43.7757011Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/fallback.rs:5:
2026-02-21T03:50:43.7757295Z  use std::path::Path;
2026-02-21T03:50:43.7757368Z  
2026-02-21T03:50:43.7757455Z  use crate::config::DdmConfig;
2026-02-21T03:50:43.7757542Z -use crate::fetch_head::HeadResult;
2026-02-21T03:50:43.7757638Z  use crate::downloader::CurlOptions;
2026-02-21T03:50:43.7757724Z +use crate::fetch_head::HeadResult;
2026-02-21T03:50:43.7757898Z  use crate::resume_db::{JobDetails, JobMetadata, JobState, ResumeDb};
2026-02-21T03:50:43.7758005Z  use crate::scheduler::execute;
2026-02-21T03:50:43.7758070Z  
2026-02-21T03:50:43.7758440Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/fallback.rs:85:
2026-02-21T03:50:43.7758503Z  
2026-02-21T03:50:43.7758573Z      Ok(())
2026-02-21T03:50:43.7758634Z  }
2026-02-21T03:50:43.7758693Z -
2026-02-21T03:50:43.7758761Z  
2026-02-21T03:50:43.7759775Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/mod.rs:9:
2026-02-21T03:50:43.7759870Z  use std::path::Path;
2026-02-21T03:50:43.7759932Z  
2026-02-21T03:50:43.7760020Z  use crate::config::DdmConfig;
2026-02-21T03:50:43.7760125Z -use crate::resume_db::{JobState, ResumeDb};
2026-02-21T03:50:43.7760217Z  use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7760320Z +use crate::resume_db::{JobState, ResumeDb};
2026-02-21T03:50:43.7760381Z  
2026-02-21T03:50:43.7760492Z  use super::budget::GlobalConnectionBudget;
2026-02-21T03:50:43.7760589Z  use super::progress::ProgressStats;
2026-02-21T03:50:43.7771391Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/shared.rs:6:
2026-02-21T03:50:43.7771628Z  use std::sync::Arc;
2026-02-21T03:50:43.7771696Z  
2026-02-21T03:50:43.7771789Z  use crate::config::DdmConfig;
2026-02-21T03:50:43.7771869Z +use crate::control::JobControl;
2026-02-21T03:50:43.7771942Z  use crate::fetch_head;
2026-02-21T03:50:43.7772034Z +use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7772203Z  use crate::resume_db::{JobMetadata, JobState, ResumeDb};
2026-02-21T03:50:43.7772280Z  use crate::safe_resume;
2026-02-21T03:50:43.7772358Z  use crate::segmenter;
2026-02-21T03:50:43.7772716Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/shared.rs:13:
2026-02-21T03:50:43.7772803Z -use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7772889Z -use crate::control::JobControl;
2026-02-21T03:50:43.7772949Z  
2026-02-21T03:50:43.7773069Z  use super::super::budget::GlobalConnectionBudget;
2026-02-21T03:50:43.7773406Z  use super::super::choose;
2026-02-21T03:50:43.7773817Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/shared.rs:39:
2026-02-21T03:50:43.7773975Z          .ok_or_else(|| anyhow::anyhow!("job {} not found", job_id))?;
2026-02-21T03:50:43.7774037Z  
2026-02-21T03:50:43.7774121Z      let url = job.url.clone();
2026-02-21T03:50:43.7774224Z -    let headers: HashMap<String, String> = job
2026-02-21T03:50:43.7774293Z -        .settings
2026-02-21T03:50:43.7774367Z -        .custom_headers
2026-02-21T03:50:43.7774432Z -        .clone()
2026-02-21T03:50:43.7774510Z -        .unwrap_or_default();
2026-02-21T03:50:43.7774769Z +    let headers: HashMap<String, String> = job.settings.custom_headers.clone().unwrap_or_default();
2026-02-21T03:50:43.7774833Z  
2026-02-21T03:50:43.7774933Z      let head = tokio::task::spawn_blocking({
2026-02-21T03:50:43.7775006Z          let url = url.clone();
2026-02-21T03:50:43.7775368Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/shared.rs:70:
2026-02-21T03:50:43.7775435Z      }
2026-02-21T03:50:43.7775495Z  
2026-02-21T03:50:43.7775714Z      let (final_name, temp_name_str, needs_metadata) = super::common::resolve_filenames(
2026-02-21T03:50:43.7775893Z -        db, job_id, &job, &head, force_restart, validation.is_err(), download_dir,
2026-02-21T03:50:43.7775958Z +        db,
2026-02-21T03:50:43.7776153Z +        job_id,
2026-02-21T03:50:43.7776224Z +        &job,
2026-02-21T03:50:43.7776287Z +        &head,
2026-02-21T03:50:43.7776356Z +        force_restart,
2026-02-21T03:50:43.7776442Z +        validation.is_err(),
2026-02-21T03:50:43.7776511Z +        download_dir,
2026-02-21T03:50:43.7776572Z      )
2026-02-21T03:50:43.7776643Z      .await?;
2026-02-21T03:50:43.7776706Z  
2026-02-21T03:50:43.7777074Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/shared.rs:119:
2026-02-21T03:50:43.7777199Z      let total_size_u = job.total_size.unwrap() as u64;
2026-02-21T03:50:43.7777324Z      let segment_count_u = job.segment_count as usize;
2026-02-21T03:50:43.7777507Z      let segments = segmenter::plan_segments(total_size_u, segment_count_u);
2026-02-21T03:50:43.7777580Z -    let mut bitmap =
2026-02-21T03:50:43.7777790Z -        segmenter::SegmentBitmap::from_bytes(&job.completed_bitmap, segment_count_u);
2026-02-21T03:50:43.7778054Z +    let mut bitmap = segmenter::SegmentBitmap::from_bytes(&job.completed_bitmap, segment_count_u);
2026-02-21T03:50:43.7778114Z  
2026-02-21T03:50:43.7778286Z      let (temp_path, final_path) = super::common::paths_and_overwrite_check(
2026-02-21T03:50:43.7778435Z -        &job, &final_name, &temp_name_str, download_dir, overwrite,
2026-02-21T03:50:43.7778501Z +        &job,
2026-02-21T03:50:43.7778567Z +        &final_name,
2026-02-21T03:50:43.7778650Z +        &temp_name_str,
2026-02-21T03:50:43.7778717Z +        download_dir,
2026-02-21T03:50:43.7778781Z +        overwrite,
2026-02-21T03:50:43.7778843Z      )?;
2026-02-21T03:50:43.7778908Z  
2026-02-21T03:50:43.7779142Z      db.set_state(job_id, JobState::Running).await?;
2026-02-21T03:50:43.7782651Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/single.rs:5:
2026-02-21T03:50:43.7782756Z  use std::path::Path;
2026-02-21T03:50:43.7782818Z  
2026-02-21T03:50:43.7782907Z  use crate::config::DdmConfig;
2026-02-21T03:50:43.7783006Z +use crate::control::JobControl;
2026-02-21T03:50:43.7783228Z  use crate::fetch_head;
2026-02-21T03:50:43.7783362Z +use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7783517Z  use crate::resume_db::{JobMetadata, JobState, ResumeDb};
2026-02-21T03:50:43.7783602Z  use crate::safe_resume;
2026-02-21T03:50:43.7783677Z  use crate::segmenter;
2026-02-21T03:50:43.7784077Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/single.rs:12:
2026-02-21T03:50:43.7784172Z -use crate::host_policy::HostPolicy;
2026-02-21T03:50:43.7784255Z -use crate::control::JobControl;
2026-02-21T03:50:43.7784315Z  
2026-02-21T03:50:43.7784451Z  use super::super::budget::GlobalConnectionBudget;
2026-02-21T03:50:43.7784532Z  use super::super::choose;
2026-02-21T03:50:43.7784902Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/single.rs:42:
2026-02-21T03:50:43.7785058Z          .ok_or_else(|| anyhow::anyhow!("job {} not found", job_id))?;
2026-02-21T03:50:43.7785126Z  
2026-02-21T03:50:43.7785204Z      let url = job.url.clone();
2026-02-21T03:50:43.7785312Z -    let headers: HashMap<String, String> = job
2026-02-21T03:50:43.7785382Z -        .settings
2026-02-21T03:50:43.7785452Z -        .custom_headers
2026-02-21T03:50:43.7785515Z -        .clone()
2026-02-21T03:50:43.7785598Z -        .unwrap_or_default();
2026-02-21T03:50:43.7785860Z +    let headers: HashMap<String, String> = job.settings.custom_headers.clone().unwrap_or_default();
2026-02-21T03:50:43.7785921Z  
2026-02-21T03:50:43.7786029Z      let head = tokio::task::spawn_blocking({
2026-02-21T03:50:43.7786109Z          let url = url.clone();
2026-02-21T03:50:43.7786480Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/single.rs:70:
2026-02-21T03:50:43.7786542Z      }
2026-02-21T03:50:43.7786607Z  
2026-02-21T03:50:43.7786820Z      let (final_name, temp_name_str, needs_metadata) = super::common::resolve_filenames(
2026-02-21T03:50:43.7787148Z -        db, job_id, &job, &head, force_restart, validation.is_err(), download_dir,
2026-02-21T03:50:43.7787217Z +        db,
2026-02-21T03:50:43.7787281Z +        job_id,
2026-02-21T03:50:43.7787344Z +        &job,
2026-02-21T03:50:43.7787409Z +        &head,
2026-02-21T03:50:43.7787485Z +        force_restart,
2026-02-21T03:50:43.7787563Z +        validation.is_err(),
2026-02-21T03:50:43.7787630Z +        download_dir,
2026-02-21T03:50:43.7787693Z      )
2026-02-21T03:50:43.7787755Z      .await?;
2026-02-21T03:50:43.7787814Z  
2026-02-21T03:50:43.7788177Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/single.rs:96:
2026-02-21T03:50:43.7788254Z      let total_size = head
2026-02-21T03:50:43.7788326Z          .content_length
2026-02-21T03:50:43.7788502Z          .ok_or_else(|| anyhow::anyhow!("server did not send Content-Length"))?;
2026-02-21T03:50:43.7788578Z -    let segment_count =
2026-02-21T03:50:43.7788752Z -        choose::choose_segment_count(total_size, cfg, &url, host_policy);
2026-02-21T03:50:43.7788971Z +    let segment_count = choose::choose_segment_count(total_size, cfg, &url, host_policy);
2026-02-21T03:50:43.7789036Z  
2026-02-21T03:50:43.7789110Z      if needs_metadata {
2026-02-21T03:50:43.7789294Z          let bitmap = segmenter::SegmentBitmap::new(segment_count);
2026-02-21T03:50:43.7789960Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/scheduler/run/single.rs:117:
2026-02-21T03:50:43.7790193Z      let total_size_u = job.total_size.unwrap() as u64;
2026-02-21T03:50:43.7790473Z      let segment_count_u = job.segment_count as usize;
2026-02-21T03:50:43.7790676Z      let segments = segmenter::plan_segments(total_size_u, segment_count_u);
2026-02-21T03:50:43.7790759Z -    let mut bitmap =
2026-02-21T03:50:43.7790970Z -        segmenter::SegmentBitmap::from_bytes(&job.completed_bitmap, segment_count_u);
2026-02-21T03:50:43.7791230Z +    let mut bitmap = segmenter::SegmentBitmap::from_bytes(&job.completed_bitmap, segment_count_u);
2026-02-21T03:50:43.7791297Z  
2026-02-21T03:50:43.7791469Z      let (temp_path, final_path) = super::common::paths_and_overwrite_check(
2026-02-21T03:50:43.7791612Z -        &job, &final_name, &temp_name_str, download_dir, overwrite,
2026-02-21T03:50:43.7791677Z +        &job,
2026-02-21T03:50:43.7791751Z +        &final_name,
2026-02-21T03:50:43.7791822Z +        &temp_name_str,
2026-02-21T03:50:43.7791923Z +        download_dir,
2026-02-21T03:50:43.7791995Z +        overwrite,
2026-02-21T03:50:43.7792057Z      )?;
2026-02-21T03:50:43.7792117Z  
2026-02-21T03:50:43.7792241Z      db.set_state(job_id, JobState::Running).await?;
2026-02-21T03:50:43.7792619Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/segmenter/bitmap.rs:132:
2026-02-21T03:50:43.7792705Z          assert!(!b.is_completed(8));
2026-02-21T03:50:43.7792767Z      }
2026-02-21T03:50:43.7792836Z  }
2026-02-21T03:50:43.7792896Z -
2026-02-21T03:50:43.7792955Z  
2026-02-21T03:50:43.7793512Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/segmenter/mod.rs:3:
2026-02-21T03:50:43.7793694Z  //! Splits a download into N segments, computes HTTP Range header bounds,
2026-02-21T03:50:43.7793866Z  //! and provides a completion bitmap for resume (serialized to DB BLOB).
2026-02-21T03:50:43.7793932Z  
2026-02-21T03:50:43.7793999Z -mod range;
2026-02-21T03:50:43.7794064Z  mod bitmap;
2026-02-21T03:50:43.7794130Z +mod range;
2026-02-21T03:50:43.7794195Z  
2026-02-21T03:50:43.7794297Z -pub use range::{Segment, plan_segments};
2026-02-21T03:50:43.7794392Z  pub use bitmap::SegmentBitmap;
2026-02-21T03:50:43.7794453Z -
2026-02-21T03:50:43.7794551Z +pub use range::{plan_segments, Segment};
2026-02-21T03:50:43.7794610Z  
2026-02-21T03:50:43.7796783Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/segmenter/range.rs:44:
2026-02-21T03:50:43.7797038Z      for i in 0..segment_count {
2026-02-21T03:50:43.7797169Z          let len = base + if i < remainder { 1 } else { 0 };
2026-02-21T03:50:43.7797275Z          let end = (offset + len).min(total_size);
2026-02-21T03:50:43.7797359Z -        out.push(Segment {
2026-02-21T03:50:43.7797428Z -            start: offset,
2026-02-21T03:50:43.7797491Z -            end,
2026-02-21T03:50:43.7797552Z -        });
2026-02-21T03:50:43.7797675Z +        out.push(Segment { start: offset, end });
2026-02-21T03:50:43.7797745Z          offset = end;
2026-02-21T03:50:43.7797806Z      }
2026-02-21T03:50:43.7797871Z  
2026-02-21T03:50:43.7798221Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/segmenter/range.rs:114:
2026-02-21T03:50:43.7798345Z          assert_eq!(s.range_header_value(), "bytes=42-42");
2026-02-21T03:50:43.7798410Z      }
2026-02-21T03:50:43.7798470Z  }
2026-02-21T03:50:43.7798530Z -
2026-02-21T03:50:43.7798590Z  
2026-02-21T03:50:43.7811304Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/storage/writer.rs:2:
2026-02-21T03:50:43.7811374Z  
2026-02-21T03:50:43.7811470Z  use anyhow::{Context, Result};
2026-02-21T03:50:43.7811548Z  use std::fs::File;
2026-02-21T03:50:43.7811624Z -use std::path::Path;
2026-02-21T03:50:43.7811696Z -use std::sync::Arc;
2026-02-21T03:50:43.7811763Z  #[cfg(unix)]
2026-02-21T03:50:43.7811871Z  use std::os::unix::fs::FileExt;
2026-02-21T03:50:43.7811945Z +use std::path::Path;
2026-02-21T03:50:43.7812015Z +use std::sync::Arc;
2026-02-21T03:50:43.7812077Z  
2026-02-21T03:50:43.7812412Z  /// Writer for a temp download file. Safe to clone and use from multiple tasks;
2026-02-21T03:50:43.7812548Z  /// each `write_at` is independent (pwrite-style).
2026-02-21T03:50:43.7812897Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/storage/writer.rs:31:
2026-02-21T03:50:43.7812970Z              .read(true)
2026-02-21T03:50:43.7813039Z              .write(true)
2026-02-21T03:50:43.7813341Z              .open(temp_path)
2026-02-21T03:50:43.7813606Z -            .with_context(|| format!("failed to open existing temp file: {}", temp_path.display()))?;
2026-02-21T03:50:43.7813683Z +            .with_context(|| {
2026-02-21T03:50:43.7813866Z +                format!("failed to open existing temp file: {}", temp_path.display())
2026-02-21T03:50:43.7813936Z +            })?;
2026-02-21T03:50:43.7814012Z          Ok(StorageWriter {
2026-02-21T03:50:43.7814095Z              file: Arc::new(file),
2026-02-21T03:50:43.7814196Z              temp_path: temp_path.to_path_buf(),
2026-02-21T03:50:43.7814536Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/storage/writer.rs:78:
2026-02-21T03:50:43.7814633Z          let temp_path = self.temp_path.clone();
2026-02-21T03:50:43.7814710Z          drop(self.file);
2026-02-21T03:50:43.7814769Z  
2026-02-21T03:50:43.7814867Z -        std::fs::rename(&temp_path, final_path)
2026-02-21T03:50:43.7815128Z -            .with_context(|| format!("failed to rename {} to {}", temp_path.display(), final_path.display()))?;
2026-02-21T03:50:43.7815278Z +        std::fs::rename(&temp_path, final_path).with_context(|| {
2026-02-21T03:50:43.7815344Z +            format!(
2026-02-21T03:50:43.7815430Z +                "failed to rename {} to {}",
2026-02-21T03:50:43.7815516Z +                temp_path.display(),
2026-02-21T03:50:43.7815598Z +                final_path.display()
2026-02-21T03:50:43.7815659Z +            )
2026-02-21T03:50:43.7815719Z +        })?;
2026-02-21T03:50:43.7815784Z          Ok(())
2026-02-21T03:50:43.7815844Z      }
2026-02-21T03:50:43.7815902Z  }
2026-02-21T03:50:43.7821575Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/url_model/content_disposition.rs:18:
2026-02-21T03:50:43.7821660Z              let v = v.trim();
2026-02-21T03:50:43.7821723Z  
2026-02-21T03:50:43.7821810Z              if name == "filename*" {
2026-02-21T03:50:43.7822196Z -                if let Some(rest) = v.strip_prefix("utf-8''").or_else(|| v.strip_prefix("UTF-8''")) {
2026-02-21T03:50:43.7822280Z +                if let Some(rest) = v
2026-02-21T03:50:43.7822372Z +                    .strip_prefix("utf-8''")
2026-02-21T03:50:43.7822489Z +                    .or_else(|| v.strip_prefix("UTF-8''"))
2026-02-21T03:50:43.7822555Z +                {
2026-02-21T03:50:43.7822681Z                      if let Ok(decoded) = percent_decode(rest) {
2026-02-21T03:50:43.7822831Z                          let decoded = decode_quoted_filename(&decoded);
2026-02-21T03:50:43.7822925Z                          if !decoded.is_empty() {
2026-02-21T03:50:43.7829802Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/url_model/mod.rs:122:
2026-02-21T03:50:43.7829972Z              derive_filename("https://example.com/", None),
2026-02-21T03:50:43.7830052Z              "download.bin"
2026-02-21T03:50:43.7830114Z          );
2026-02-21T03:50:43.7830188Z -        assert_eq!(
2026-02-21T03:50:43.7830324Z -            derive_filename("https://example.com", None),
2026-02-21T03:50:43.7830419Z -            "download.bin"
2026-02-21T03:50:43.7830482Z -        );
2026-02-21T03:50:43.7830696Z +        assert_eq!(derive_filename("https://example.com", None), "download.bin");
2026-02-21T03:50:43.7830757Z      }
2026-02-21T03:50:43.7830817Z  
2026-02-21T03:50:43.7830883Z      #[test]
2026-02-21T03:50:43.7831235Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/url_model/mod.rs:132:
2026-02-21T03:50:43.7831350Z      fn derive_filename_reserved_names_fallback() {
2026-02-21T03:50:43.7831701Z -        assert_eq!(derive_filename("https://example.com/.", None), "download.bin");
2026-02-21T03:50:43.7831918Z -        assert_eq!(derive_filename("https://example.com/..", None), "download.bin");
2026-02-21T03:50:43.7831988Z +        assert_eq!(
2026-02-21T03:50:43.7832115Z +            derive_filename("https://example.com/.", None),
2026-02-21T03:50:43.7832199Z +            "download.bin"
2026-02-21T03:50:43.7832264Z +        );
2026-02-21T03:50:43.7832330Z +        assert_eq!(
2026-02-21T03:50:43.7832460Z +            derive_filename("https://example.com/..", None),
2026-02-21T03:50:43.7832532Z +            "download.bin"
2026-02-21T03:50:43.7832593Z +        );
2026-02-21T03:50:43.7832653Z      }
2026-02-21T03:50:43.7832719Z  
2026-02-21T03:50:43.7832781Z      #[test]
2026-02-21T03:50:43.7833322Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/url_model/mod.rs:138:
2026-02-21T03:50:43.7833443Z      fn unique_filename_among_no_collision() {
2026-02-21T03:50:43.7833606Z +        assert_eq!(unique_filename_among("file.iso", &[]), "file.iso");
2026-02-21T03:50:43.7833677Z          assert_eq!(
2026-02-21T03:50:43.7833779Z -            unique_filename_among("file.iso", &[]),
2026-02-21T03:50:43.7833856Z -            "file.iso"
2026-02-21T03:50:43.7833918Z -        );
2026-02-21T03:50:43.7833986Z -        assert_eq!(
2026-02-21T03:50:43.7834150Z              unique_filename_among("file.iso", &["other.zip".to_string()]),
2026-02-21T03:50:43.7834217Z              "file.iso"
2026-02-21T03:50:43.7834281Z          );
2026-02-21T03:50:43.7834615Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/url_model/mod.rs:153:
2026-02-21T03:50:43.7834685Z              "file (1).iso"
2026-02-21T03:50:43.7834747Z          );
2026-02-21T03:50:43.7834813Z          assert_eq!(
2026-02-21T03:50:43.7835060Z -            unique_filename_among("file.iso", &["file.iso".to_string(), "file (1).iso".to_string()]),
2026-02-21T03:50:43.7835146Z +            unique_filename_among(
2026-02-21T03:50:43.7835222Z +                "file.iso",
2026-02-21T03:50:43.7835355Z +                &["file.iso".to_string(), "file (1).iso".to_string()]
2026-02-21T03:50:43.7835470Z +            ),
2026-02-21T03:50:43.7835593Z              "file (2).iso"
2026-02-21T03:50:43.7835695Z          );
2026-02-21T03:50:43.7835989Z      }
2026-02-21T03:50:43.7836479Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/url_model/sanitize.rs:64:
2026-02-21T03:50:43.7836542Z  
2026-02-21T03:50:43.7836618Z      #[test]
2026-02-21T03:50:43.7836705Z      fn collapses_underscores() {
2026-02-21T03:50:43.7836902Z -        assert_eq!(sanitize_filename_for_linux("file___name.txt"), "file_name.txt");
2026-02-21T03:50:43.7836975Z +        assert_eq!(
2026-02-21T03:50:43.7837093Z +            sanitize_filename_for_linux("file___name.txt"),
2026-02-21T03:50:43.7837163Z +            "file_name.txt"
2026-02-21T03:50:43.7837222Z +        );
2026-02-21T03:50:43.7837335Z      }
2026-02-21T03:50:43.7837574Z  
2026-02-21T03:50:43.7837669Z      #[test]
2026-02-21T03:50:43.7838066Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/src/url_model/sanitize.rs:71:
2026-02-21T03:50:43.7838212Z      fn control_chars() {
2026-02-21T03:50:43.7838478Z -        assert_eq!(sanitize_filename_for_linux("file\x00name.txt"), "file_name.txt");
2026-02-21T03:50:43.7838568Z +        assert_eq!(
2026-02-21T03:50:43.7838774Z +            sanitize_filename_for_linux("file\x00name.txt"),
2026-02-21T03:50:43.7838929Z +            "file_name.txt"
2026-02-21T03:50:43.7839022Z +        );
2026-02-21T03:50:43.7839112Z      }
2026-02-21T03:50:43.7839242Z  }
2026-02-21T03:50:43.7839318Z  
2026-02-21T03:50:43.7867498Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/tests/common/range_server.rs:85:
2026-02-21T03:50:43.7867685Z          let use_range = opts.support_ranges;
2026-02-21T03:50:43.7868025Z          let (status, range_header, slice) = if use_range {
2026-02-21T03:50:43.7876139Z              if let Some((start, end_incl)) = range {
2026-02-21T03:50:43.7876327Z -            let start = start.min(total);
2026-02-21T03:50:43.7876494Z -            let end_incl = end_incl.min(total.saturating_sub(1));
2026-02-21T03:50:43.7876596Z -            if start > end_incl {
2026-02-21T03:50:43.7876678Z -                (
2026-02-21T03:50:43.7876781Z -                    "416 Range Not Satisfiable",
2026-02-21T03:50:43.7876891Z -                    format!("bytes */{}", total),
2026-02-21T03:50:43.7877006Z -                    &body[0..0],
2026-02-21T03:50:43.7877070Z -                )
2026-02-21T03:50:43.7877169Z +                let start = start.min(total);
2026-02-21T03:50:43.7877318Z +                let end_incl = end_incl.min(total.saturating_sub(1));
2026-02-21T03:50:43.7877401Z +                if start > end_incl {
2026-02-21T03:50:43.7877466Z +                    (
2026-02-21T03:50:43.7877580Z +                        "416 Range Not Satisfiable",
2026-02-21T03:50:43.7877677Z +                        format!("bytes */{}", total),
2026-02-21T03:50:43.7877755Z +                        &body[0..0],
2026-02-21T03:50:43.7877824Z +                    )
2026-02-21T03:50:43.7877894Z +                } else {
2026-02-21T03:50:43.7877986Z +                    let start = start as usize;
2026-02-21T03:50:43.7878125Z +                    let end_excl = (end_incl + 1).min(total) as usize;
2026-02-21T03:50:43.7878301Z +                    let slice = body.get(start..end_excl).unwrap_or(&body[0..0]);
2026-02-21T03:50:43.7878366Z +                    (
2026-02-21T03:50:43.7878458Z +                        "206 Partial Content",
2026-02-21T03:50:43.7878644Z +                        format!("bytes {}-{}/{}", start, end_excl.saturating_sub(1), total),
2026-02-21T03:50:43.7878716Z +                        slice,
2026-02-21T03:50:43.7878779Z +                    )
2026-02-21T03:50:43.7878846Z +                }
2026-02-21T03:50:43.7878940Z              } else {
2026-02-21T03:50:43.7879090Z -                let start = start as usize;
2026-02-21T03:50:43.7879306Z -                let end_excl = (end_incl + 1).min(total) as usize;
2026-02-21T03:50:43.7879559Z -                let slice = body.get(start..end_excl).unwrap_or(&body[0..0]);
2026-02-21T03:50:43.7879626Z                  (
2026-02-21T03:50:43.7879890Z -                    "206 Partial Content",
2026-02-21T03:50:43.7880077Z -                    format!("bytes {}-{}/{}", start, end_excl.saturating_sub(1), total),
2026-02-21T03:50:43.7880150Z -                    slice,
2026-02-21T03:50:43.7880220Z +                    "200 OK",
2026-02-21T03:50:43.7880373Z +                    format!("bytes 0-{}/{}", total.saturating_sub(1), total),
2026-02-21T03:50:43.7880443Z +                    body,
2026-02-21T03:50:43.7880505Z                  )
2026-02-21T03:50:43.7880569Z              }
2026-02-21T03:50:43.7880642Z -            } else {
2026-02-21T03:50:43.7880707Z -            (
2026-02-21T03:50:43.7880777Z -                "200 OK",
2026-02-21T03:50:43.7880925Z -                format!("bytes 0-{}/{}", total.saturating_sub(1), total),
2026-02-21T03:50:43.7880993Z -                body,
2026-02-21T03:50:43.7881057Z -            )
2026-02-21T03:50:43.7881121Z -            }
2026-02-21T03:50:43.7881194Z          } else {
2026-02-21T03:50:43.7881263Z              (
2026-02-21T03:50:43.7881331Z                  "200 OK",
2026-02-21T03:50:43.7881732Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/tests/common/range_server.rs:125:
2026-02-21T03:50:43.7881819Z          let response = format!(
2026-02-21T03:50:43.7881976Z              "HTTP/1.1 {}\r\nContent-Length: {}\r\nContent-Range: {}\r\n{}\
2026-02-21T03:50:43.7882046Z  \r\n",
2026-02-21T03:50:43.7882185Z -            status, slice.len(), range_header, accept_ranges
2026-02-21T03:50:43.7882252Z +            status,
2026-02-21T03:50:43.7882326Z +            slice.len(),
2026-02-21T03:50:43.7882506Z +            range_header,
2026-02-21T03:50:43.7882585Z +            accept_ranges
2026-02-21T03:50:43.7882650Z          );
2026-02-21T03:50:43.7882771Z          let _ = stream.write_all(response.as_bytes());
2026-02-21T03:50:43.7882865Z          let _ = stream.write_all(slice);
2026-02-21T03:50:43.7883493Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/tests/integration_range_download.rs:45:
2026-02-21T03:50:43.7883571Z  
2026-02-21T03:50:43.7883738Z      let job = db.get_job(job_id).await.unwrap().expect("job exists");
2026-02-21T03:50:43.7883927Z      assert_eq!(job.state, JobState::Completed, "job should be completed");
2026-02-21T03:50:43.7884005Z -    let final_name = job
2026-02-21T03:50:43.7884083Z -        .final_filename
2026-02-21T03:50:43.7884152Z -        .as_deref()
2026-02-21T03:50:43.7884236Z -        .unwrap_or("download.bin");
2026-02-21T03:50:43.7884424Z +    let final_name = job.final_filename.as_deref().unwrap_or("download.bin");
2026-02-21T03:50:43.7884566Z      let final_path = download_dir.path().join(final_name);
2026-02-21T03:50:43.7884707Z      assert!(final_path.exists(), "final file should exist");
2026-02-21T03:50:43.7884828Z      let content = std::fs::read(&final_path).unwrap();
2026-02-21T03:50:43.7885236Z Diff in /home/runner/work/Debian-Download-Manager/Debian-Download-Manager/crates/ddm-core/tests/integration_range_download.rs:90:
2026-02-21T03:50:43.7885345Z      .expect("run_one_job with multi backend");
2026-02-21T03:50:43.7885408Z  
2026-02-21T03:50:43.7885562Z      let job = db.get_job(job_id).await.unwrap().expect("job exists");
2026-02-21T03:50:43.7885760Z -    assert_eq!(job.state, JobState::Completed, "multi backend should complete");
2026-02-21T03:50:43.7885836Z -    let final_name = job
2026-02-21T03:50:43.7885912Z -        .final_filename
2026-02-21T03:50:43.7885979Z -        .as_deref()
2026-02-21T03:50:43.7886064Z -        .unwrap_or("download.bin");
2026-02-21T03:50:43.7886133Z +    assert_eq!(
2026-02-21T03:50:43.7886206Z +        job.state,
2026-02-21T03:50:43.7886292Z +        JobState::Completed,
2026-02-21T03:50:43.7886384Z +        "multi backend should complete"
2026-02-21T03:50:43.7886447Z +    );
2026-02-21T03:50:43.7886642Z +    let final_name = job.final_filename.as_deref().unwrap_or("download.bin");
2026-02-21T03:50:43.7886767Z      let final_path = download_dir.path().join(final_name);
2026-02-21T03:50:43.7887031Z      assert!(final_path.exists(), "final file should exist");
2026-02-21T03:50:43.7887155Z      let content = std::fs::read(&final_path).unwrap();
2026-02-21T03:50:43.7915351Z ##[error]Process completed with exit code 1.
2026-02-21T03:50:43.8020744Z Post job cleanup.
2026-02-21T03:50:43.8977833Z [command]/usr/bin/git version
2026-02-21T03:50:43.9012617Z git version 2.52.0
2026-02-21T03:50:43.9055869Z Temporarily overriding HOME='/home/runner/work/_temp/df4e25c9-57cd-44c3-9425-8be3ac98a21e' before making global git config changes
2026-02-21T03:50:43.9057280Z Adding repository directory to the temporary git global config as a safe directory
2026-02-21T03:50:43.9068914Z [command]/usr/bin/git config --global --add safe.directory /home/runner/work/Debian-Download-Manager/Debian-Download-Manager
2026-02-21T03:50:43.9245561Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2026-02-21T03:50:43.9281089Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2026-02-21T03:50:43.9743331Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2026-02-21T03:50:43.9764656Z http.https://github.com/.extraheader
2026-02-21T03:50:43.9780726Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader
2026-02-21T03:50:44.0836464Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2026-02-21T03:50:44.1057860Z [command]/usr/bin/git config --local --name-only --get-regexp ^includeIf\.gitdir:
2026-02-21T03:50:44.1087951Z [command]/usr/bin/git submodule foreach --recursive git config --local --show-origin --name-only --get-regexp remote.origin.url
2026-02-21T03:50:44.1399829Z Cleaning up orphan processes
